const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lesson-edit-ChhedkY3.js","assets/main-Dw1yuUwf.js","assets/preload-helper-DPi8upcZ.js","assets/main-Bd0mlOr_.css","assets/icons-D1xy210t.js","assets/lessons-journal-edit-form-w1OtwTkm.js","assets/button-CZ8BjX0E.js","assets/select-field-CyfcuCvi.js","assets/cleanable-B5JIVvlz.js","assets/formik.esm-Bvm5ZwHr.js","assets/use-dropdown-DWskSKMx.js","assets/index.browser-OxPLOBIU.js","assets/text-field-BKZ9EOHO.js","assets/lessons-selector-DfGyvcHt.js","assets/rating-create-CQwRLBxV.js","assets/ratings-create-form-MfqaqoIx.js","assets/index.esm-Cn9hwLpj.js","assets/mark-create-_z0kOTCc.js","assets/marks-create-form-KkltcNzx.js","assets/content-field-BSM_19N7.js","assets/marks-KWTxiGgr.js"])))=>i.map(i=>d[i]);
import{r as n,q as _,j as e,c as k,S as P,u as G,a as w,o as H,z as q,B as Z,h as D,a6 as O,L as Q,v as W,A as X,m as ee,w as te,x as se,Z as ne}from"./main-Dw1yuUwf.js";import{a as ae,g as oe}from"./grades-selector-7JnXScQQ.js";import{b as K,c as ie,a as re,d as V,e as ce,g as le}from"./ratings-BIdJYIqz.js";import{a as me,g as de}from"./subjects-selector-CFx4eaql.js";import{a as ue,g as xe}from"./users-selector-DnYDMv9p.js";import{_ as Y}from"./preload-helper-DPi8upcZ.js";import{c as ge,a as fe}from"./index-C4_IihsQ.js";import{u as pe,c as he,f as be}from"./index-B2E4MO7_.js";import{a as je}from"./marks-KWTxiGgr.js";const we=n.lazy(()=>Y(()=>import("./lesson-edit-ChhedkY3.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])));function ye({data:c,columns:f,setLessons:l,lessonObject:r}){const[p,m]=n.useState(),[d,C]=n.useState({left:["name"],right:[]}),v=pe({data:c,columns:f,getCoreRowModel:he(),state:{columnPinning:d},onColumnPinningChange:C}),y=n.useCallback(g=>o=>{const h=o.currentTarget.getBoundingClientRect(),b=h.top+80+4,N=h.left;m({dto:{id:g.id,topic:g.topic,homework:g.homework,type_id:g.typeId},position:{top:b,left:N},title:_(g.date).format("DD MMMM YYYY"),onClose:()=>m(void 0),onSuccess:M=>l((R=[])=>{const I=R.findIndex(E=>E.id===M.id);return I!==-1&&(R[I]=M),[...R]})})},[l]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col rounded-md shadow border bg-white overflow-scroll max-h-[calc(100vh-52px)] styled-scrollbar text-sm md:text-[16px]",children:[e.jsx("div",{className:"sticky top-0 z-40 shadow min-w-max",children:v.getHeaderGroups().map(g=>e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex items-end leading-none justify-end p-1 min-w-7 max-w-7 font-semibold bg-gray-100 md:p-2 md:min-w-9 md:max-w-9",children:"№"}),g.headers.map(o=>o.id==="name"?e.jsx("div",{className:"flex items-end bg-gray-100 p-1 md:p-2 leading-none font-semibold min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px] min-h-20 max-h-20 sticky left-0 z-10 border-r",children:"Ф.И."},o.id):o.id.length===13?e.jsx("div",{className:"relative flex bg-gray-100 min-w-9 max-w-9 min-h-[80px] max-h-[80px] border-r text-[13px]",children:e.jsx("span",{className:"absolute left-full bottom-0 flex items-center justify-start px-1 origin-bottom-left -rotate-90 h-9 w-[80px] text-blue-600",children:K[+o.id.split("_")[1]]})},o.id):e.jsx("div",{className:"flex flex-col min-h-[80px] max-h-[80px] min-w-9 max-w-9",children:e.jsxs("button",{className:"relative flex items-center grow justify-center font-normal bg-gray-100 border-r cursor-pointer duration-150 hover:bg-gray-200",onClick:y(r[o.id]),children:[e.jsx("span",{className:"font-semibold mt-auto",children:o.id.split("_")[0].slice(-2)}),e.jsx("span",{className:"absolute left-0 top-[52px] origin-top-left -rotate-90 h-9 flex items-center w-12  text-sm",children:ge(_(o.id.split("_")[0]).format("MMM"))})]})},o.id))]},g.id))}),e.jsx("div",{className:"min-w-max",children:v.getRowModel().rows.map((g,o)=>e.jsxs("div",{className:k("flex",o%2?"bg-gray-50":"bg-white"),children:[e.jsxs("div",{className:k("flex items-center justify-end p-1 min-w-7 max-w-7 min-h-9 max-h-9 md:p-2 md:min-w-9 md:max-w-9",o%2?"bg-gray-50":"bg-white"),children:[o+1,"."]}),g.getVisibleCells().map((h,b)=>{var N;return e.jsx("div",{className:k(b===0&&"sticky left-0 border-r",o%2?"bg-gray-50 border-r":"bg-white border-r",(N=h.column.columnDef.meta)==null?void 0:N.columnClass),children:be(h.column.columnDef.cell,h.getContext())},JSON.stringify(h))})]},g.original.id))})]}),p&&e.jsx(n.Suspense,{fallback:e.jsx(P,{className:"w-8 h-8"}),children:e.jsx(we,{...p})})]})}const Se=n.memo(ye),_e=n.lazy(()=>Y(()=>import("./rating-create-CQwRLBxV.js"),__vite__mapDeps([14,1,2,3,4,15,16,6,9,12,8,11]))),Ce=n.lazy(()=>Y(()=>import("./mark-create-_z0kOTCc.js"),__vite__mapDeps([17,1,2,3,4,18,16,6,19,8,9,7,10,11,20,12])));function ve(){const c=G(),f=w(ie),l=w(re),r=w(ue),[p]=H(),m=p.get("subjectId"),d=p.get("gradeId"),C=fe(),v=l==null?void 0:l.find(({years:s})=>s==C),[y,g]=n.useState(),[o,h]=n.useState(),[b,N]=n.useState(),[M,R]=n.useState(),[I,E]=n.useState();n.useEffect(()=>{m&&d&&(c(q({subjectId:+m,gradeId:+d,onSuccess:s=>{g(s),c(Z({lessons:s.map(({id:t})=>t),onSuccess:t=>N(t)}))}})),f!==D.Loading&&c(O({years:C,subjectId:+m,gradeId:+d,onSuccess:s=>h(s)})))},[c,d,f,m,C]);const S=n.useMemo(()=>{const s={};if(o)return o.forEach(t=>{const a=`${t.studentId}_${V[t.rating]}`;s[a]=t}),s},[o]),j=n.useMemo(()=>{const s={};if(b)return b.forEach(t=>{const a=`${t.studentId}_${t.lessonId}`;s[a]=t}),s},[b]),z=n.useMemo(()=>{const s={};if(y)return y.forEach(t=>{const a=`${t.date}_${t.hour}_${t.id}`;s[a]=t}),s},[y]),$=n.useMemo(()=>{if(v&&y){const s=y.map(t=>`${t.date}_${t.hour}_${t.id}`);return Object.entries(V).forEach(([t,a])=>{v[t]&&s.push(`${v[t]}_${a}`)}),s.sort(),s}},[v,y]),L=n.useMemo(()=>{if($&&r&&d&&m&&b)return r.filter(s=>{var t;return((t=s.student)==null?void 0:t.gradeId)===+d}).map(s=>{const t=$.reduce((a,i)=>{if(i.length==13){const u=S==null?void 0:S[`${s.id}_${i.split("_")[1]}`];a[i]=u}else{const u=j==null?void 0:j[`${s.id}_${i.split("_")[2]}`];a[i]=u}return a},{});return{id:s.id,name:`${s.surname} ${s.name}`,...t}})},[d,$,j,b,S,m,r]),B=n.useCallback((s,t)=>a=>{const i=a.currentTarget.getBoundingClientRect(),u=i.top+36+4,x=i.left+36+4;R({dto:s,position:{top:u,left:x},studentName:t,onClose:()=>R(void 0),onSuccess:A=>h((T=[])=>[...T,A])})},[]),J=n.useCallback((s,t)=>a=>{const i=a.currentTarget.getBoundingClientRect(),u=i.top+36+4,x=i.left+36+4;E({dto:s,position:{top:u,left:x},studentName:t,onClose:()=>E(void 0),onSuccess:A=>N((T=[])=>[...T,A])})},[]),U=n.useMemo(()=>{if($&&d&&m&&j)return[{id:"name",accessorKey:"name",header:"Ф.И.",size:180,cell:({row:s})=>e.jsx(Q,{className:"flex items-center px-1 w-max h-max leading-none",to:W(X.Users.Show,{id:s.original.id}),children:s.original.name}),meta:{columnClass:"flex items-center min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px]"}},...$.reduce((s,t)=>{if(t.length===13){const[a,i]=t.split("_");s.push({id:t,accessorKey:t,header:K[+i],cell:({row:u})=>{const x=S==null?void 0:S[`${u.original.id}_${i}`];return x?e.jsx("div",{className:"flex items-center justify-center min-w-9 min-h-9",children:x.score}):_(a)>_()?void 0:e.jsx("button",{className:"flex min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5",type:"button",onClick:B({rating:ce[+i],years:C,student_id:u.original.id,grade_id:+d,subject_id:+m},u.original.name)})},meta:{columnClass:"flex items-center justify-end min-w-9 max-w-9 min-h-9 max-h-9"}})}else{const[a,,i]=t.split("_");s.push({id:t,accessorKey:t,header:a,size:40,cell:({row:u})=>{const x=j==null?void 0:j[`${u.original.id}_${i}`];return x?e.jsxs("div",{className:"flex items-center justify-center min-w-9 min-h-9",children:[x.score1,x.score1&&x.score2&&"/",x.score2,!x.score1&&!x.score2&&je[x.attendance]]}):_(a)>_()?void 0:e.jsx("button",{className:"flex min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5",type:"button",onClick:J({attendance:"",lesson_id:+i,student_id:u.original.id},u.original.name)})},enableSorting:!1,meta:{columnClass:k("flex items-center justify-center min-w-9 max-w-9 min-h-9 max-h-9 border-r",_(a).format("YYYY-MM-DD")===_().format("YYYY-MM-DD")&&"!bg-green-50")}})}return s},[])]},[d,$,j,J,B,S,m,C]);if(!(!d||!m))return!L||!U?e.jsx(P,{className:"w-8 h-8"}):e.jsxs(e.Fragment,{children:[z&&e.jsx(Se,{data:L,columns:U,setLessons:g,lessonObject:z}),M&&e.jsx(n.Suspense,{fallback:e.jsx(P,{className:"w-8 h-8"}),children:e.jsx(_e,{...M})}),I&&e.jsx(n.Suspense,{fallback:e.jsx(P,{className:"w-8 h-8"}),children:e.jsx(Ce,{...I})})]})}const Ne=n.memo(ve);function F({className:c,inputClass:f,value:l,options:r,placeholder:p}){var m;return e.jsx("div",{className:k(c,"relative flex flex-col"),children:e.jsx("div",{className:"relative flex",children:e.jsx("button",{className:k("flex items-center min-h-8 max-h-8 grow bg-gray-50 min-w-0 border border-gray-200 rounded px-2 leading-none text-sm focus:outline-none hover:bg-gray-100 focus:border-primary focus:bg-gray-100 md:text-[16px]",!l&&"text-[#a8a3b7]",f),type:"button",children:l?(m=r.find(d=>d.value===l))==null?void 0:m.label:p})})})}function Re(){const c=w(ae),f=w(me),[l]=H();return e.jsxs("header",{className:"relative z-50 flex gap-x-1 gap-y-1 items-end",children:[e.jsx("h1",{className:"title",children:"Журнал"}),e.jsx(F,{className:"min-w-10",placeholder:"Класс",options:(c||[]).map(r=>({value:r.id.toString(),label:`${r.level} ${r.group}`})),value:l.get("gradeId")||""}),e.jsx(F,{className:"grow max-w-[320px]",placeholder:"Предмет",options:(f||[]).map(r=>({value:r.id.toString(),label:r.name})),value:l.get("subjectId")||""})]})}const $e=n.memo(Re);function ze(){const c=G(),f=w(oe),l=w(de),r=w(xe),p=w(le);return n.useEffect(()=>{f===D.Idle&&c(ee()),l===D.Idle&&c(te()),r===D.Idle&&c(se()),p===D.Idle&&c(ne())},[c,f,p,l,r]),e.jsxs("main",{className:"flex flex-col gap-y-1 py-2",children:[e.jsx($e,{}),e.jsx(Ne,{})]})}export{ze as default};
