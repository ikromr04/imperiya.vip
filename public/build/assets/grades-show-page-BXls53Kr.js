import{u as E,d as U,j as e,R as B,y as S,E as b,A as x,a as I,r as w,D as G,T as L,e as O,k as R,z as F,S as T,L as A,B as V,N as q}from"./main-D1X-5qeh.js";import f from"./not-found-page-Dlt1yDD_.js";import{B as h}from"./button-BxcCnYcJ.js";import{F as $,a as _}from"./formik.esm-CEA5_Xoc.js";import{S as v}from"./select-field-DvwSWDo-.js";import{g as k}from"./users-selector-Cpbhop2B.js";import{c as M,a as z,e as H}from"./index.esm-tVQjNZt4.js";import{I as y}from"./icons-Cwm3zsc5.js";import{B as J}from"./breadcrumbs-YnKa2wrI.js";import{M as C}from"./modal-COah0HVy.js";import{T as K}from"./tooltip-BpooByUR.js";import{g as Q}from"./grades-selector-CjDDihwd.js";import"./preload-helper-DPi8upcZ.js";import"./cleanable-BYiEZa8s.js";import"./use-dropdown-BjzLPdm1.js";import"./index.browser-OxPLOBIU.js";const D=(i,o)=>{const t=i.map(({id:d})=>d),r=t.indexOf(o);if(r===-1)throw new Error("Current grade ID not found in the list of grades");const s=(r+1)%t.length;return t[s]},W=(i,o)=>{const t=i.map(({id:d})=>d),r=t.indexOf(o);if(r===-1)throw new Error("Current grade ID not found in the list of grades");const s=(r-1+t.length)%t.length;return t[s]};function X({grade:i,grades:o,setIsOpen:t}){const r=E(),s=U(),d=async(m,p)=>{p.setSubmitting(!0),await r(B({id:i.id,onSuccess:()=>{S.success("Класс успешно удален."),t(!1),s(b(x.Classes.Show,{id:D(o,i.id)}))},onFail:u=>S.error(u)})),p.setSubmitting(!1)};return e.jsx($,{initialValues:{},onSubmit:d,children:({isSubmitting:m})=>e.jsxs(_,{children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-4",children:[e.jsx("h3",{className:"title",children:"Удаление класса"}),e.jsx(h,{className:"ml-auto",type:"reset",icon:"close",variant:"danger",onClick:()=>t(!1),children:e.jsx("span",{className:"sr-only",children:"Отмена"})})]}),e.jsx("div",{className:"mb-4",children:e.jsx("p",{className:"mb-2",children:"Вы уверены что хотите удалить данный класс? Все данные связанные с этим классом будут удалены."})}),e.jsx("div",{className:"flex items-center justify-end gap-2 sm:col-span-2",children:e.jsx(h,{className:"justify-center min-w-[92px]",type:"submit",disabled:m,loading:m,variant:"success",icon:"delete",children:"Удалить"})})]})},i.id)}const Y=M().shape({level:H().required("Обязательное поле."),group:z().required("Обязательное поле.")});function Z({grade:i,grades:o,setIsOpen:t}){var u;const r=E(),s=I(k),d=(u=s.data)==null?void 0:u.filter(n=>{var l;return((l=n.student)==null?void 0:l.gradeId)===i.id}),m={id:i.id,level:i.level,group:i.group,teacher_id:i.teacherId,students:(d==null?void 0:d.map(({id:n})=>n))||[]};w.useEffect(()=>{!s.data&&!s.isFetching&&r(G())},[r,s.data,s.isFetching]);const p=async(n,l)=>{if(l.setSubmitting(!0),o.some(c=>c.id!==n.id&&c.level===n.level&&c.group===n.group)){l.setErrors({level:"Выбранный класс уже существует.",group:" "});return}await r(L({dto:n,onSuccess:()=>{S.success("Данные успешно сохранены."),t(!1)},onValidationError:c=>l.setErrors({...c.errors}),onFail:c=>S.success(c)})),l.setSubmitting(!1)};if(s.data)return e.jsx($,{initialValues:m,validationSchema:Y,onSubmit:p,children:({isSubmitting:n,values:l})=>{var g,c,j;return e.jsxs(_,{children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-4",children:[e.jsx("h3",{className:"title",children:"Редактирование класса"}),e.jsx(h,{className:"ml-auto",type:"reset",icon:"close",variant:"danger",onClick:()=>t(!1),children:e.jsx("span",{className:"sr-only",children:"Отмена"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 mb-2",children:[e.jsx(v,{name:"level",label:"Уровень",options:[1,2,3,4,5,6,7,8,9,10,11].map(a=>({value:a,label:a.toString()}))}),e.jsx(v,{name:"group",label:"Группа",options:["А","Б","В","Г","Д","Е"].map(a=>({value:a,label:a.toString()}))})]}),e.jsx(v,{className:"mb-4",name:"teacher_id",searchable:!0,label:"Руководитель",options:((g=s.data)==null?void 0:g.filter(a=>a.role==="teacher").map(a=>({value:a.id,label:`${a.surname} ${a.name}`})))||[]}),e.jsx(v,{className:"mb-4",name:"students",multiple:!0,searchable:!0,label:`Ученики (${(c=l.students)==null?void 0:c.length})`,options:((j=s.data)==null?void 0:j.filter(a=>a.role==="student").map(a=>({value:a.id,label:`${a.surname} ${a.name}`})))||[]}),e.jsx("div",{className:"flex items-center justify-end gap-2 sm:col-span-2",children:e.jsx(h,{className:"justify-center min-w-[92px]",type:"submit",icon:"update",disabled:n,loading:n,variant:"success",children:"Сохранить"})})]})}})}function ee(){var g,c,j;const i=E(),o=O(),t=I(Q),r=I(k),s=((g=t.data)==null?void 0:g.find(({id:a})=>a===+(o.id||0)))||null,[d,m]=w.useState(!1),[p,u]=w.useState(!1),n=(c=r.data)==null?void 0:c.filter(a=>{var N;return((N=a.student)==null?void 0:N.gradeId)===(s==null?void 0:s.id)}),l=(j=r.data)==null?void 0:j.find(({id:a})=>a===(s==null?void 0:s.teacherId));return w.useEffect(()=>{!s&&!t.isFetching&&o.id&&i(R()),!r.data&&!r.isFetching&&i(G())},[i,s,t.isFetching,o.id,r.data,r.isFetching]),!s||!t.data?e.jsx(F,{children:e.jsx(T,{className:"w-8 h-8"})}):e.jsxs(F,{children:[e.jsxs("main",{className:"pt-4 pb-40",children:[e.jsx(J,{items:[["Все классы",x.Classes.Index],[`${s.level} ${s.group}`,""]]}),e.jsx("header",{className:"flex items-end justify-end mb-4",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(h,{variant:"light",href:b(x.Classes.Show,{id:W(t.data,s.id)}),children:[e.jsx(y.previous,{width:14,height:14}),e.jsx("span",{className:"sr-only md:not-sr-only",children:"Предыдущий"})]}),e.jsxs(h,{variant:"light",href:b(x.Classes.Show,{id:D(t.data,s.id)}),children:[e.jsx("span",{className:"sr-only md:not-sr-only",children:"Следующий"}),e.jsx(y.next,{width:14,height:14})]})]})}),e.jsxs("div",{className:"box",children:[e.jsxs("div",{className:"box__header",children:[e.jsxs("h1",{className:"title",children:["Класс ",s.level,e.jsx("sup",{children:'"'}),s.group,e.jsx("sup",{children:'"'})]}),e.jsxs(h,{variant:"light",onClick:()=>m(!0),children:[e.jsx(y.edit,{width:14,height:14}),e.jsx(K,{label:"Редактировать",position:"left"})]})]}),e.jsxs("section",{className:"box__body",children:[e.jsx("h2",{className:"title !text-lg",children:"Руководитель"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:l&&e.jsxs(A,{className:"py-1 px-2 border rounded bg-gray-100 hover:bg-blue-50",to:b(x.Users.Show,{id:l.id}),children:[l.surname," ",l.name," ",l.patronymic]})})]}),e.jsxs("section",{className:"box__body",children:[e.jsxs("h2",{className:"title !text-lg",children:["Ученики (",n==null?void 0:n.length,")"]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:n==null?void 0:n.map(({id:a,surname:N,name:P})=>e.jsxs(A,{className:"py-1 px-2 border rounded bg-gray-100 hover:bg-blue-50",to:b(x.Users.Show,{id:a}),children:[N," ",P]},a))})]})]}),e.jsxs(h,{className:"ml-auto mt-2 md:mt-4",variant:"danger",onClick:()=>u(!0),children:[e.jsx(y.delete,{width:14,height:14}),"Удалить класс"]})]}),e.jsx(C,{isOpen:p,children:e.jsx(X,{grades:t.data,grade:s,setIsOpen:u})}),e.jsx(C,{isOpen:d,children:e.jsx(Z,{grade:s,grades:t.data,setIsOpen:m})})]})}const se={superadmin:()=>e.jsx(ee,{}),admin:()=>e.jsx(f,{}),director:()=>e.jsx(f,{}),teacher:()=>e.jsx(f,{}),parent:()=>e.jsx(f,{}),student:()=>e.jsx(f,{})};function fe(){const i=I(V);return i?se[i.role]():e.jsx(q,{to:x.Auth.Login})}export{fe as default};
