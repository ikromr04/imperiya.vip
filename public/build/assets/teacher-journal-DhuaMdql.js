const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lesson-edit-4ESzbPfm.js","assets/main-BjKjkFnO.js","assets/preload-helper-BfFHrpNk.js","assets/main-DNTo822Q.css","assets/icons-2GKCzqG_.js","assets/lessons-journal-edit-form-B1jIi4GN.js","assets/button-C0MfaOJU.js","assets/select-field-CV1C-mEI.js","assets/cleanable-BRYLRZ_0.js","assets/formik.esm-DpEu7PzI.js","assets/use-dropdown-CQm-e309.js","assets/index.browser-OxPLOBIU.js","assets/text-field-B-Ag5Fwc.js","assets/lessons-selector-a3lLWfQq.js"])))=>i.map(i=>d[i]);
import{r,t as D,j as a,c as E,S as J,a as U,u as N,p as G,ae as X,af as q,i as P,aj as Q,ak as Z,y as Y,am as L,L as O,X as ee,A as te,n as se,C as ae,v as ne,W as ie}from"./main-BjKjkFnO.js";import{a as re,g as oe}from"./grades-selector-vTNl7uIh.js";import{b as le,a as ce,g as me}from"./ratings-selector-pO-woBjb.js";import{a as de,g as ue}from"./subjects-selector-6HcjDJlK.js";import{a as fe,g as xe}from"./users-selector-5OWV2O4j.js";import{b as H,a as V,c as pe}from"./ratings-CKd6Gnpx.js";import{c as ge,g as he}from"./index-22Ha7Ynr.js";import{_ as ye}from"./preload-helper-BfFHrpNk.js";import{u as be,c as we,f as Se}from"./index-D4Yc8kE2.js";import{a as _e}from"./marks-KWTxiGgr.js";const je=r.lazy(()=>ye(()=>import("./lesson-edit-4ESzbPfm.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])));function Ne({data:o,columns:y,setLessons:u,lessonObject:m}){const[S,f]=r.useState(),[x,C]=r.useState({left:["name"],right:[]}),$=be({data:o,columns:y,getCoreRowModel:we(),state:{columnPinning:x},onColumnPinningChange:C}),v=r.useCallback(p=>l=>{const _=l.currentTarget.getBoundingClientRect(),g=_.top+80+4,M=_.left;f({dto:{id:p.id,topic:p.topic,homework:p.homework,type_id:p.typeId},position:{top:g,left:M},title:D(p.date).format("DD MMMM YYYY"),onClose:()=>f(void 0),onSuccess:b=>u((h=[])=>{const k=h.findIndex(w=>w.id===b.id);return k!==-1&&(h[k]=b),[...h]})})},[u]);return a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex flex-col rounded-md shadow border bg-white overflow-scroll max-h-[calc(100vh-52px)] styled-scrollbar text-sm md:text-[16px]",children:[a.jsx("div",{className:"sticky top-0 z-40 shadow min-w-max",children:$.getHeaderGroups().map(p=>a.jsxs("div",{className:"flex",children:[a.jsx("div",{className:"flex items-end leading-none justify-end p-1 min-w-7 max-w-7 font-semibold bg-gray-100 md:p-2 md:min-w-9 md:max-w-9",children:"№"}),p.headers.map(l=>l.id==="name"?a.jsx("div",{className:"flex items-end bg-gray-100 p-1 md:p-2 leading-none font-semibold min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px] min-h-20 max-h-20 sticky left-0 z-10 border-r",children:"Ф.И."},l.id):l.id.length===13?a.jsx("div",{className:"relative flex bg-gray-100 min-w-9 max-w-9 min-h-[80px] max-h-[80px] border-r text-[13px]",children:a.jsx("span",{className:"absolute left-full bottom-0 flex items-center justify-start px-1 origin-bottom-left -rotate-90 h-9 w-[80px] text-blue-600",children:H[+l.id.split("_")[1]]})},l.id):a.jsx("div",{className:"flex flex-col min-h-[80px] max-h-[80px] min-w-9 max-w-9",children:a.jsxs("button",{className:"relative flex items-center grow justify-center font-normal bg-gray-100 border-r cursor-pointer duration-150 hover:bg-gray-200",onClick:v(m[l.id]),children:[a.jsx("span",{className:"font-semibold mt-auto",children:l.id.split("_")[0].slice(-2)}),a.jsx("span",{className:"absolute left-0 top-[52px] origin-top-left -rotate-90 h-9 flex items-center w-12  text-sm",children:ge(D(l.id.split("_")[0]).format("MMM"))})]})},l.id))]},p.id))}),a.jsx("div",{className:"min-w-max",children:$.getRowModel().rows.map((p,l)=>a.jsxs("div",{className:E("flex",l%2?"bg-gray-50":"bg-white"),children:[a.jsxs("div",{className:E("flex items-center justify-end p-1 min-w-7 max-w-7 min-h-9 max-h-9 md:p-2 md:min-w-9 md:max-w-9",l%2?"bg-gray-50":"bg-white"),children:[l+1,"."]}),p.getVisibleCells().map((_,g)=>{var M;return a.jsx("div",{className:E(g===0&&"sticky left-0 border-r",l%2?"bg-gray-50 border-r":"bg-white border-r",(M=_.column.columnDef.meta)==null?void 0:M.columnClass),children:Se(_.column.columnDef.cell,_.getContext())},JSON.stringify(_))})]},p.original.id))})]}),S&&a.jsx(r.Suspense,{fallback:a.jsx(J,{className:"w-8 h-8"}),children:a.jsx(je,{...S})})]})}const ve=r.memo(Ne);function Ce(){const o=U(),y=N(le),u=N(ce),m=N(fe),[S]=G(),f=S.get("subjectId"),x=S.get("gradeId"),C=he(),$=u==null?void 0:u.find(({years:t})=>t==C),[v,p]=r.useState(),[l,_]=r.useState(),[g,M]=r.useState();r.useEffect(()=>{f&&x&&(o(X({subjectId:+f,gradeId:+x,onSuccess:t=>{p(t),o(q({lessons:t.map(({id:e})=>e),onSuccess:e=>M(e)}))}})),y!==P.Loading&&o(Q({years:C,subjectId:+f,gradeId:+x,onSuccess:t=>_(t)})))},[o,x,y,f,C]);const b=r.useMemo(()=>{const t={};if(l)return l.forEach(e=>{const n=`${e.studentId}_${V[e.rating]}`;t[n]=e}),t},[l]),h=r.useMemo(()=>{const t={};if(g)return g.forEach(e=>{const n=`${e.studentId}_${e.lessonId}`;t[n]=e}),t},[g]),k=r.useMemo(()=>{const t={};if(v)return v.forEach(e=>{const n=`${e.date}_${e.hour}_${e.id}`;t[n]=e}),t},[v]),w=r.useMemo(()=>{if($&&v){const t=v.map(e=>`${e.date}_${e.hour}_${e.id}`);return Object.entries(V).forEach(([e,n])=>{$[e]&&t.push(`${$[e]}_${n}`)}),t.sort(),t}},[$,v]),s=r.useMemo(()=>{if(w)return w.reduce((e,n)=>{if(n.length===13){const i=Number(n.split("_")[1]);e.data[i]=e.lessonIds,e.lessonIds=[]}else{const i=Number(n.split("_")[2]);e.lessonIds.push(i)}return e},{lessonIds:[],data:{}})},[w]),T=r.useMemo(()=>{if(w&&m&&x&&f&&g)return m.filter(t=>{var e;return((e=t.student)==null?void 0:e.gradeId)===+x}).map(t=>{const e=w.reduce((n,i)=>{if(i.length==13){const d=b==null?void 0:b[`${t.id}_${i.split("_")[1]}`];n[i]=d}else{const d=h==null?void 0:h[`${t.id}_${i.split("_")[2]}`];n[i]=d}return n},{});return{id:t.id,name:`${t.surname} ${t.name}`,...e}})},[x,w,h,g,b,f,m]),z=r.useCallback(t=>async e=>{const n=+e.target.value.trim();if(n&&n>=1&&n<=10&&n!==+e.target.defaultValue)e.target.classList.add("opacity-50"),t.score=n,await o(Z({dto:t,onSuccess:i=>_((d=[])=>[...d,i]),onValidationError:i=>Y.error(i.message),onFail:i=>Y.success(i)})),e.target.classList.remove("opacity-50");else{e.target.value=e.target.defaultValue;return}},[o]),B=r.useCallback(t=>async e=>{const n=e.target.value.toLowerCase().trim();if(n==="н")t.attendance="A";else{const[i,d]=n.split(/ (.+)/),[c,j]=i.split("/");if(!(+c>=1&&+c<=10)){e.target.value="";return}if(j&&!(+j>=1&&+j<=10)){e.target.value="";return}t.score_1=+c,t.score_2=+j||void 0,t.comment=d==null?void 0:d.trim(),t.attendance="P"}e.target.classList.add("opacity-50"),await o(L({dto:t,onSuccess:i=>M((d=[])=>[...d,i]),onFail:i=>Y.success(i)})),e.target.classList.remove("opacity-50")},[o]),F=r.useMemo(()=>{if(w&&x&&f&&h)return[{id:"name",accessorKey:"name",header:"Ф.И.",size:180,cell:({row:t})=>a.jsx(O,{className:"flex items-center px-1 w-max h-max leading-none",to:ee(te.Users.Show,{id:t.original.id}),children:t.original.name}),meta:{columnClass:"flex items-center min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px]"}},...w.reduce((t,e)=>{if(e.length===13){const[,n]=e.split("_");t.push({id:e,accessorKey:e,header:H[+n],cell:({row:i})=>{const d=b==null?void 0:b[`${i.original.id}_${n}`];if(!d){let c=0,j=0,R=[];n==="93"?R=[...(s==null?void 0:s.data[91])||[],...(s==null?void 0:s.data[92])||[],...(s==null?void 0:s.data[93])||[]]:n==="96"?R=[...(s==null?void 0:s.data[94])||[],...(s==null?void 0:s.data[95])||[],...(s==null?void 0:s.data[96])||[]]:n==="97"?R=[...(s==null?void 0:s.data[91])||[],...(s==null?void 0:s.data[92])||[],...(s==null?void 0:s.data[93])||[],...(s==null?void 0:s.data[94])||[],...(s==null?void 0:s.data[95])||[],...(s==null?void 0:s.data[96])||[]]:R=(s==null?void 0:s.data[+n])||[],g==null||g.map(A=>{R!=null&&R.includes(A.lessonId)&&A.studentId===i.original.id&&(A.score1&&(c=c+A.score1,j=j+1),A.score2&&(c=c+A.score2,j=j+1))});const K=c/j||0,W=!["98","99"].includes(n)&&K.toFixed(2)||"";return a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 cursor-pointer hover:bg-blue-50 bg-transparent focus:outline-0 text-blue-500 placeholder:text-blue-300",type:"number",onBlur:z({rating:pe[+n],years:C,student_id:i.original.id,grade_id:+x,subject_id:+f}),placeholder:W})}return a.jsx("div",{className:"flex items-center font-semibold text-blue-500 justify-center min-w-9 min-h-9",children:d.score})},meta:{columnClass:"flex items-center justify-end min-w-9 max-w-9 min-h-9 max-h-9"}})}else{const[n,,i]=e.split("_");t.push({id:e,accessorKey:e,header:n,size:40,cell:({row:d})=>{const c=h==null?void 0:h[`${d.original.id}_${i}`];return c?a.jsxs("div",{className:"flex items-center justify-center min-w-9 min-h-9",children:[c.score1,c.score1&&c.score2&&"/",c.score2,!c.score1&&!c.score2&&_e[c.attendance]]}):D(n)>D()?void 0:a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5 bg-transparent focus:outline-0",onBlur:B({attendance:"",lesson_id:+i,student_id:d.original.id})})},enableSorting:!1,meta:{columnClass:E("flex items-center justify-center min-w-9 max-w-9 min-h-9 max-h-9 border-r",D(n).format("YYYY-MM-DD")===D().format("YYYY-MM-DD")&&"!bg-green-50")}})}return t},[])]},[x,w,h,g,B,z,s==null?void 0:s.data,b,f,C]);if(!(!x||!f))return!T||!F?a.jsx(J,{className:"w-8 h-8"}):a.jsx(a.Fragment,{children:k&&a.jsx(ve,{data:T,columns:F,setLessons:p,lessonObject:k})})}const $e=r.memo(Ce);function I({className:o,inputClass:y,value:u,options:m,placeholder:S}){var f;return a.jsx("div",{className:E(o,"relative flex flex-col"),children:a.jsx("div",{className:"relative flex",children:a.jsx("button",{className:E("flex items-center min-h-8 max-h-8 grow bg-gray-50 min-w-0 border border-gray-200 rounded px-2 leading-none text-sm focus:outline-none hover:bg-gray-100 focus:border-primary focus:bg-gray-100 md:text-[16px]",!u&&"text-[#a8a3b7]",y),type:"button",children:u?(f=m.find(x=>x.value===u))==null?void 0:f.label:S})})})}function Me(){const o=N(re),y=N(de),[u]=G();return a.jsxs("header",{className:"relative z-50 flex gap-x-1 gap-y-1 items-end",children:[a.jsx("h1",{className:"title",children:"Журнал"}),a.jsx(I,{className:"min-w-10",placeholder:"Класс",options:(o||[]).map(m=>({value:m.id.toString(),label:`${m.level} ${m.group}`})),value:u.get("gradeId")||""}),a.jsx(I,{className:"grow max-w-[320px]",placeholder:"Предмет",options:(y||[]).map(m=>({value:m.id.toString(),label:m.name})),value:u.get("subjectId")||""})]})}const Re=r.memo(Me);function Ve(){const o=U(),y=N(oe),u=N(ue),m=N(xe),S=N(me);return r.useEffect(()=>{y===P.Idle&&o(se()),u===P.Idle&&o(ae()),m===P.Idle&&o(ne()),S===P.Idle&&o(ie())},[o,y,S,u,m]),a.jsxs("main",{className:"flex flex-col gap-y-1 py-2",children:[a.jsx(Re,{}),a.jsx($e,{})]})}export{Ve as default};
