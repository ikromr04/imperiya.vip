const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lesson-edit-mcqKyMyA.js","assets/main-DzOvJ3Bl.js","assets/preload-helper-BfFHrpNk.js","assets/main-CSYpzwAj.css","assets/icons-B5TgyNC1.js","assets/lessons-journal-edit-form-Chh17a4S.js","assets/button-BK2ewXLd.js","assets/select-field-Dot3bTik.js","assets/cleanable-37L1pogH.js","assets/formik.esm-Cpulkf5n.js","assets/use-dropdown-D7UlQ3WZ.js","assets/index.browser-OxPLOBIU.js","assets/text-field-yJsTwbK9.js","assets/lessons-selector-53yG18IO.js"])))=>i.map(i=>d[i]);
import{r,t as E,j as a,c as P,S as K,a as W,u as C,p as X,ae as Q,af as Z,i as T,aj as L,ak as O,y as B,am as ee,L as te,X as se,A as ae,n as ne,C as ie,v as re,W as oe}from"./main-DzOvJ3Bl.js";import{a as le,g as ce}from"./grades-selector-XXuKk_5g.js";import{b as me,a as ue,g as de}from"./ratings-selector-CZBQg-ih.js";import{a as fe,g as xe}from"./subjects-selector-CkFIZtiD.js";import{a as pe,g as ge}from"./users-selector-BLV6X7VS.js";import{b as q,a as G,c as he}from"./ratings-CKd6Gnpx.js";import{c as ye,g as be}from"./index-DnzxYe6g.js";import{_ as we}from"./preload-helper-BfFHrpNk.js";import{u as Se,c as je,f as ve}from"./index-D18-tjuz.js";const _e=r.lazy(()=>we(()=>import("./lesson-edit-mcqKyMyA.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])));function Ne({data:o,columns:y,setLessons:d,lessonObject:m}){const[S,f]=r.useState(),[x,M]=r.useState({left:["name"],right:[]}),R=Se({data:o,columns:y,getCoreRowModel:je(),state:{columnPinning:x},onColumnPinningChange:M}),$=r.useCallback(g=>l=>{const j=l.currentTarget.getBoundingClientRect(),h=j.top+80+4,A=j.left;f({dto:{id:g.id,topic:g.topic,homework:g.homework,type_id:g.typeId},position:{top:h,left:A},title:E(g.date).format("DD MMMM YYYY"),onClose:()=>f(void 0),onSuccess:k=>d((D=[])=>{const b=D.findIndex(w=>w.id===k.id);return b!==-1&&(D[b]=k),[...D]})})},[d]);return a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex flex-col rounded-md shadow border bg-white overflow-scroll max-h-[calc(100vh-52px)] styled-scrollbar text-sm md:text-[16px]",children:[a.jsx("div",{className:"sticky top-0 z-40 shadow min-w-max",children:R.getHeaderGroups().map(g=>a.jsxs("div",{className:"flex",children:[a.jsx("div",{className:"flex items-end leading-none justify-end p-1 min-w-7 max-w-7 font-semibold bg-gray-100 md:p-2 md:min-w-9 md:max-w-9",children:"№"}),g.headers.map(l=>l.id==="name"?a.jsx("div",{className:"flex items-end bg-gray-100 p-1 md:p-2 leading-none font-semibold min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px] min-h-20 max-h-20 sticky left-0 z-10 border-r",children:"Ф.И."},l.id):l.id.length===13?a.jsx("div",{className:"relative flex bg-gray-100 min-w-9 max-w-9 min-h-[80px] max-h-[80px] border-r text-[13px]",children:a.jsx("span",{className:"absolute left-full bottom-0 flex items-center justify-start px-1 origin-bottom-left -rotate-90 h-9 w-[80px] text-blue-600",children:q[+l.id.split("_")[1]]})},l.id):a.jsx("div",{className:"flex flex-col min-h-[80px] max-h-[80px] min-w-9 max-w-9",children:a.jsxs("button",{className:"relative flex items-center grow justify-center font-normal bg-gray-100 border-r cursor-pointer duration-150 hover:bg-gray-200",onClick:$(m[l.id]),children:[a.jsx("span",{className:"font-semibold mt-auto",children:l.id.split("_")[0].slice(-2)}),a.jsx("span",{className:"absolute left-0 top-[52px] origin-top-left -rotate-90 h-9 flex items-center w-12  text-sm",children:ye(E(l.id.split("_")[0]).format("MMM"))})]})},l.id))]},g.id))}),a.jsx("div",{className:"min-w-max",children:R.getRowModel().rows.map((g,l)=>a.jsxs("div",{className:P("flex",l%2?"bg-gray-50":"bg-white"),children:[a.jsxs("div",{className:P("flex items-center justify-end p-1 min-w-7 max-w-7 min-h-9 max-h-9 md:p-2 md:min-w-9 md:max-w-9",l%2?"bg-gray-50":"bg-white"),children:[l+1,"."]}),g.getVisibleCells().map((j,h)=>{var A;return a.jsx("div",{className:P(h===0&&"sticky left-0 border-r",l%2?"bg-gray-50 border-r":"bg-white border-r",(A=j.column.columnDef.meta)==null?void 0:A.columnClass),children:ve(j.column.columnDef.cell,j.getContext())},JSON.stringify(j))})]},g.original.id))})]}),S&&a.jsx(r.Suspense,{fallback:a.jsx(K,{className:"w-8 h-8"}),children:a.jsx(_e,{...S})})]})}const Ce=r.memo(Ne);function $e(){const o=W(),y=C(me),d=C(ue),m=C(pe),[S]=X(),f=S.get("subjectId"),x=S.get("gradeId"),M=be(),R=d==null?void 0:d.find(({years:t})=>t==M),[$,g]=r.useState(),[l,j]=r.useState(),[h,A]=r.useState(),[k,D]=r.useState();r.useEffect(()=>{f&&x&&(o(Q({subjectId:+f,gradeId:+x,onSuccess:t=>{g(t),o(Z({lessons:t.map(({id:e})=>e),onSuccess:e=>A(e)}))}})),y!==T.Loading&&o(L({years:M,subjectId:+f,gradeId:+x,onSuccess:t=>j(t)})))},[o,x,y,f,M]);const b=r.useMemo(()=>{const t={};if(l)return l.forEach(e=>{const n=`${e.studentId}_${G[e.rating]}`;t[n]=e}),t},[l]),w=r.useMemo(()=>{const t={};if(h)return h.forEach(e=>{const n=`${e.studentId}_${e.lessonId}`;t[n]=e}),t},[h]),F=r.useMemo(()=>{const t={};if($)return $.forEach(e=>{const n=`${e.date}_${e.hour}_${e.id}`;t[n]=e}),t},[$]),N=r.useMemo(()=>{if(R&&$){const t=$.map(e=>`${e.date}_${e.hour}_${e.id}`);return Object.entries(G).forEach(([e,n])=>{R[e]&&t.push(`${R[e]}_${n}`)}),t.sort(),t}},[R,$]),s=r.useMemo(()=>{if(N)return N.reduce((e,n)=>{if(n.length===13){const i=Number(n.split("_")[1]);e.data[i]=e.lessonIds,e.lessonIds=[]}else{const i=Number(n.split("_")[2]);e.lessonIds.push(i)}return e},{lessonIds:[],data:{}})},[N]),V=r.useMemo(()=>{if(N&&m&&x&&f&&h)return m.filter(t=>{var e;return((e=t.student)==null?void 0:e.gradeId)===+x}).map(t=>{const e=N.reduce((n,i)=>{if(i.length==13){const u=b==null?void 0:b[`${t.id}_${i.split("_")[1]}`];n[i]=u}else{const u=w==null?void 0:w[`${t.id}_${i.split("_")[2]}`];n[i]=u}return n},{});return{id:t.id,name:`${t.surname} ${t.name}`,...e}})},[x,N,w,h,b,f,m]),I=r.useCallback(t=>async e=>{const n=+e.target.value.trim();if(n&&n>=1&&n<=10&&n!==+e.target.defaultValue)e.target.classList.add("opacity-50"),t.score=n,await o(O({dto:t,onSuccess:i=>j((u=[])=>[...u,i]),onValidationError:i=>B.error(i.message),onFail:i=>B.success(i)})),e.target.classList.remove("opacity-50");else{e.target.value=e.target.defaultValue;return}},[o]),J=r.useCallback(t=>async e=>{const n=e.target.value.toLowerCase().trim();if(n==="н")t.attendance="A";else if(n==="п")t.attendance="P";else{const[i,u]=n.split(/ (.+)/),[c,p]=i.split("/");if(!(+c>=1&&+c<=10)){e.target.value="";return}if(p&&!(+p>=1&&+p<=10)){e.target.value="";return}t.score_1=+c,t.score_2=+p||void 0,t.comment=u==null?void 0:u.trim(),t.attendance="P"}e.target.classList.add("opacity-50"),await o(ee({dto:t,onSuccess:i=>A((u=[])=>[...u,i]),onFail:i=>B.success(i)})),e.target.classList.remove("opacity-50")},[o]),U=r.useMemo(()=>{if(N&&x&&f&&w)return[{id:"name",accessorKey:"name",header:"Ф.И.",size:180,cell:({row:t})=>a.jsx(te,{className:"flex items-center px-1 w-max h-max leading-none",to:se(ae.Users.Show,{id:t.original.id}),children:t.original.name}),meta:{columnClass:"flex items-center min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px]"}},...N.reduce((t,e)=>{if(e.length===13){const[,n]=e.split("_");t.push({id:e,accessorKey:e,header:q[+n],cell:({row:i})=>{const u=b==null?void 0:b[`${i.original.id}_${n}`];if(!u){let c=0,p=0,v=[];n==="93"?v=[...(s==null?void 0:s.data[91])||[],...(s==null?void 0:s.data[92])||[],...(s==null?void 0:s.data[93])||[]]:n==="96"?v=[...(s==null?void 0:s.data[94])||[],...(s==null?void 0:s.data[95])||[],...(s==null?void 0:s.data[96])||[]]:n==="97"?v=[...(s==null?void 0:s.data[91])||[],...(s==null?void 0:s.data[92])||[],...(s==null?void 0:s.data[93])||[],...(s==null?void 0:s.data[94])||[],...(s==null?void 0:s.data[95])||[],...(s==null?void 0:s.data[96])||[]]:v=(s==null?void 0:s.data[+n])||[],h==null||h.map(_=>{v!=null&&v.includes(_.lessonId)&&_.studentId===i.original.id&&(_.score1&&(c=c+_.score1,p=p+1),_.score2&&(c=c+_.score2,p=p+1))});const z=c/p||0,Y=!["98","99"].includes(n)&&z.toFixed(2)||"";return a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 cursor-pointer hover:bg-blue-50 bg-transparent focus:outline-0 text-blue-500 placeholder:text-blue-300",type:"number",onBlur:I({rating:he[+n],years:M,student_id:i.original.id,grade_id:+x,subject_id:+f}),placeholder:Y})}return a.jsx("div",{className:"flex items-center font-semibold text-blue-500 justify-center min-w-9 min-h-9",children:u.score})},meta:{columnClass:"flex items-center justify-end min-w-9 max-w-9 min-h-9 max-h-9"}})}else{const[n,,i]=e.split("_");t.push({id:e,accessorKey:e,header:n,size:40,cell:({row:u})=>{var v,z;const c=w==null?void 0:w[`${u.original.id}_${i}`];if(!c)return E(n)>E()?void 0:a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5 bg-transparent focus:outline-0",onBlur:J({attendance:"",lesson_id:+i,student_id:u.original.id})});let p="";if(c.score1||c.score2){const Y=((v=c.score1)==null?void 0:v.toString())??"",_=((z=c.score2)==null?void 0:z.toString())??"";p=Y&&_?`${Y}/${_}`:Y||_}else c.attendance==="A"?p="н":c.attendance==="P"&&(p="п");return a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5 bg-transparent focus:outline-0",onBlur:()=>D(void 0),onFocus:()=>D(c.comment),readOnly:!0,defaultValue:p})},enableSorting:!1,meta:{columnClass:P("flex items-center justify-center min-w-9 max-w-9 min-h-9 max-h-9 border-r",E(n).format("YYYY-MM-DD")===E().format("YYYY-MM-DD")&&"!bg-green-50")}})}return t},[])]},[x,N,w,h,J,I,s==null?void 0:s.data,b,f,M]);if(!(!x||!f))return!V||!U?a.jsx(K,{className:"w-8 h-8"}):a.jsxs(a.Fragment,{children:[F&&a.jsx(Ce,{data:V,columns:U,setLessons:g,lessonObject:F}),k&&a.jsx("div",{className:"fixed right-1 bottom-1 m-0 bg-white py-1 px-2 border",children:k})]})}const Me=r.memo($e);function H({className:o,inputClass:y,value:d,options:m,placeholder:S}){var f;return a.jsx("div",{className:P(o,"relative flex flex-col"),children:a.jsx("div",{className:"relative flex",children:a.jsx("button",{className:P("flex items-center min-h-8 max-h-8 grow bg-gray-50 min-w-0 border border-gray-200 rounded px-2 leading-none text-sm focus:outline-none hover:bg-gray-100 focus:border-primary focus:bg-gray-100 md:text-[16px]",!d&&"text-[#a8a3b7]",y),type:"button",children:d?(f=m.find(x=>x.value===d))==null?void 0:f.label:S})})})}function Re(){const o=C(le),y=C(fe),[d]=X();return a.jsxs("header",{className:"relative z-50 flex gap-x-1 gap-y-1 items-end",children:[a.jsx("h1",{className:"title",children:"Журнал"}),a.jsx(H,{className:"min-w-10",placeholder:"Класс",options:(o||[]).map(m=>({value:m.id.toString(),label:`${m.level} ${m.group}`})),value:d.get("gradeId")||""}),a.jsx(H,{className:"grow max-w-[320px]",placeholder:"Предмет",options:(y||[]).map(m=>({value:m.id.toString(),label:m.name})),value:d.get("subjectId")||""})]})}const Ae=r.memo(Re);function Ve(){const o=W(),y=C(ce),d=C(xe),m=C(ge),S=C(de);return r.useEffect(()=>{y===T.Idle&&o(ne()),d===T.Idle&&o(ie()),m===T.Idle&&o(re()),S===T.Idle&&o(oe())},[o,y,S,d,m]),a.jsxs("main",{className:"flex flex-col gap-y-1 py-2",children:[a.jsx(Ae,{}),a.jsx(Me,{})]})}export{Ve as default};
