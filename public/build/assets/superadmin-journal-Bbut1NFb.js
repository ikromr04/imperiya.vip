const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lesson-edit-BpPxVL32.js","assets/main-DyZOqu_f.js","assets/preload-helper-BfFHrpNk.js","assets/main-CZMWdHFf.css","assets/icons-B6vILnyY.js","assets/lessons-journal-edit-form-m_eAviDd.js","assets/button-CqoFrGdL.js","assets/select-field-CpciObgG.js","assets/cleanable-DkdZPN_b.js","assets/formik.esm-ngpA7fMQ.js","assets/use-dropdown-ziopbjS6.js","assets/index.browser-OxPLOBIU.js","assets/text-field-D4LhElGt.js","assets/lessons-selector-EFAjZkxe.js","assets/rating-create-COqXc11X.js","assets/ratings-create-form-CrNhYzAq.js","assets/index.esm-ChdKR4l3.js","assets/rating-edit-D7KU2hkO.js","assets/mark-create-CyggaLXl.js","assets/marks-create-form-uy5MGH5Y.js","assets/content-field-BJsavVVG.js","assets/marks-KWTxiGgr.js","assets/mark-edit-aLZZGl84.js"])))=>i.map(i=>d[i]);
import{r as o,t as I,j as e,c as P,S as A,a as ee,u as k,p as te,ae as ne,af as ae,i as z,aj as oe,L as ie,X as re,A as le,n as ce,C as de,v as me,W as ue}from"./main-DyZOqu_f.js";import{a as fe,g as xe}from"./grades-selector-BiqlozJL.js";import{b as pe,a as ge,g as he}from"./ratings-selector-B2DIC-Hr.js";import{a as be,g as ye}from"./subjects-selector-CXlH5nlQ.js";import{a as we,g as _e}from"./users-selector-BUDb_wLN.js";import{_ as B}from"./preload-helper-BfFHrpNk.js";import{b as se,a as L,c as Ce}from"./ratings-CKd6Gnpx.js";import{c as je,g as Se}from"./index-Cel6jvoj.js";import{u as ve,c as Ne,f as Re}from"./index-B7h0mGKW.js";import{a as ke}from"./marks-KWTxiGgr.js";import{u as Ee}from"./use-dropdown-ziopbjS6.js";const Me=o.lazy(()=>B(()=>import("./lesson-edit-BpPxVL32.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])));function $e({data:x,columns:w,setLessons:u,lessonObject:b}){const[c,p]=o.useState(),[g,v]=o.useState({left:["name"],right:[]}),j=ve({data:x,columns:w,getCoreRowModel:Ne(),state:{columnPinning:g},onColumnPinningChange:v}),_=o.useCallback(f=>r=>{const C=r.currentTarget.getBoundingClientRect(),y=C.top+80+4,E=C.left;p({dto:{id:f.id,topic:f.topic,homework:f.homework,type_id:f.typeId},position:{top:y,left:E},title:I(f.date).format("DD MMMM YYYY"),onClose:()=>p(void 0),onSuccess:T=>u((D=[])=>{const Y=D.findIndex(V=>V.id===T.id);return Y!==-1&&(D[Y]=T),[...D]})})},[u]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col rounded-md shadow border bg-white overflow-scroll max-h-[calc(100vh-52px)] styled-scrollbar text-sm md:text-[16px]",children:[e.jsx("div",{className:"sticky top-0 z-40 shadow min-w-max",children:j.getHeaderGroups().map(f=>e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex items-end leading-none justify-end p-1 min-w-7 max-w-7 font-semibold bg-gray-100 md:p-2 md:min-w-9 md:max-w-9",children:"№"}),f.headers.map(r=>r.id==="name"?e.jsx("div",{className:"flex items-end bg-gray-100 p-1 md:p-2 leading-none font-semibold min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px] min-h-20 max-h-20 sticky left-0 z-10 border-r",children:"Ф.И."},r.id):r.id.length===13?e.jsx("div",{className:"relative flex bg-gray-100 min-w-9 max-w-9 min-h-[80px] max-h-[80px] border-r text-[13px]",children:e.jsx("span",{className:"absolute left-full bottom-0 flex items-center justify-start px-1 origin-bottom-left -rotate-90 h-9 w-[80px] text-blue-600",children:se[+r.id.split("_")[1]]})},r.id):e.jsx("div",{className:"flex flex-col min-h-[80px] max-h-[80px] min-w-9 max-w-9",children:e.jsxs("button",{className:"relative flex items-center grow justify-center font-normal bg-gray-100 border-r cursor-pointer duration-150 hover:bg-gray-200",onClick:_(b[r.id]),children:[e.jsx("span",{className:"font-semibold mt-auto",children:r.id.split("_")[0].slice(-2)}),e.jsx("span",{className:"absolute left-0 top-[52px] origin-top-left -rotate-90 h-9 flex items-center w-12  text-sm",children:je(I(r.id.split("_")[0]).format("MMM"))})]})},r.id))]},f.id))}),e.jsx("div",{className:"min-w-max",children:j.getRowModel().rows.map((f,r)=>e.jsxs("div",{className:P("flex",r%2?"bg-gray-50":"bg-white"),children:[e.jsxs("div",{className:P("flex items-center justify-end p-1 min-w-7 max-w-7 min-h-9 max-h-9 md:p-2 md:min-w-9 md:max-w-9",r%2?"bg-gray-50":"bg-white"),children:[r+1,"."]}),f.getVisibleCells().map((C,y)=>{var E;return e.jsx("div",{className:P(y===0&&"sticky left-0 border-r",r%2?"bg-gray-50 border-r":"bg-white border-r",(E=C.column.columnDef.meta)==null?void 0:E.columnClass),children:Re(C.column.columnDef.cell,C.getContext())},JSON.stringify(C))})]},f.original.id))})]}),c&&e.jsx(o.Suspense,{fallback:e.jsx(A,{className:"w-8 h-8"}),children:e.jsx(Me,{...c})})]})}const Pe=o.memo($e),De=o.lazy(()=>B(()=>import("./rating-create-COqXc11X.js"),__vite__mapDeps([14,1,2,3,4,15,16,6,9,12,8,11]))),Ae=o.lazy(()=>B(()=>import("./rating-edit-D7KU2hkO.js"),__vite__mapDeps([17,1,2,3,4,6,12,8,9,11]))),Ie=o.lazy(()=>B(()=>import("./mark-create-CyggaLXl.js"),__vite__mapDeps([18,1,2,3,4,19,16,6,20,8,9,7,10,11,21,12]))),Te=o.lazy(()=>B(()=>import("./mark-edit-aLZZGl84.js"),__vite__mapDeps([22,1,2,3,4,6,20,8,9,7,10,11,12,21])));function Ye(){const x=ee(),w=k(pe),u=k(ge),b=k(we),[c]=te(),p=c.get("subjectId"),g=c.get("gradeId"),v=Se(),j=u==null?void 0:u.find(({years:s})=>s==v),[_,f]=o.useState(),[r,C]=o.useState(),[y,E]=o.useState(),[T,D]=o.useState(),[Y,V]=o.useState(),[F,J]=o.useState(),[U,G]=o.useState();o.useEffect(()=>{p&&g&&(x(ne({subjectId:+p,gradeId:+g,onSuccess:s=>{f(s),x(ae({lessons:s.map(({id:t})=>t),onSuccess:t=>E(t)}))}})),w!==z.Loading&&x(oe({years:v,subjectId:+p,gradeId:+g,onSuccess:s=>C(s)})))},[x,g,w,p,v]);const M=o.useMemo(()=>{const s={};if(r)return r.forEach(t=>{const a=`${t.studentId}_${L[t.rating]}`;s[a]=t}),s},[r]),N=o.useMemo(()=>{const s={};if(y)return y.forEach(t=>{const a=`${t.studentId}_${t.lessonId}`;s[a]=t}),s},[y]),H=o.useMemo(()=>{const s={};if(_)return _.forEach(t=>{const a=`${t.date}_${t.hour}_${t.id}`;s[a]=t}),s},[_]),R=o.useMemo(()=>{if(j&&_){const s=_.map(t=>`${t.date}_${t.hour}_${t.id}`);return Object.entries(L).forEach(([t,a])=>{j[t]&&s.push(`${j[t]}_${a}`)}),s.sort(),s}},[j,_]),n=o.useMemo(()=>{if(R)return R.reduce((t,a)=>{if(a.length===13){const i=Number(a.split("_")[1]);t.data[i]=t.lessonIds,t.lessonIds=[]}else{const i=Number(a.split("_")[2]);t.lessonIds.push(i)}return t},{lessonIds:[],data:{}})},[R]),K=o.useMemo(()=>{if(R&&b&&g&&p&&y)return b.filter(s=>{var t;return((t=s.student)==null?void 0:t.gradeId)===+g}).map(s=>{const t=R.reduce((a,i)=>{if(i.length==13){const d=M==null?void 0:M[`${s.id}_${i.split("_")[1]}`];a[i]=d}else{const d=N==null?void 0:N[`${s.id}_${i.split("_")[2]}`];a[i]=d}return a},{});return{id:s.id,name:`${s.surname} ${s.name}`,...t}})},[g,R,N,y,M,p,b]),W=o.useCallback((s,t)=>a=>{const i=a.currentTarget.getBoundingClientRect(),d=i.top+36+4,l=i.left+36+4;D({dto:s,position:{top:d,left:l},studentName:t,onClose:()=>D(void 0),onSuccess:h=>C((m=[])=>[...m,h])})},[]),X=o.useCallback((s,t)=>a=>{const i=a.currentTarget.getBoundingClientRect(),d=i.top+36+4,l=i.left+36+4;V({dto:s,position:{top:d,left:l},studentName:t,onClose:()=>V(void 0),onSuccess:h=>C((m=[])=>{const $=m.findIndex(S=>S.id===h.id);return $!==-1&&(m[$]=h),[...m]})})},[]),q=o.useCallback((s,t)=>a=>{const i=a.currentTarget.getBoundingClientRect(),d=i.top+36+4,l=i.left+36+4;J({dto:s,position:{top:d,left:l},studentName:t,onClose:()=>J(void 0),onSuccess:h=>E((m=[])=>[...m,h])})},[]),Q=o.useCallback((s,t)=>a=>{const i=a.currentTarget.getBoundingClientRect(),d=i.top+36+4,l=i.left+36+4;G({dto:s,position:{top:d,left:l},studentName:t,onClose:()=>G(void 0),onSuccess:h=>E((m=[])=>{const $=m.findIndex(S=>S.id===h.id);return $!==-1&&(m[$]=h),[...m]})})},[]),Z=o.useMemo(()=>{if(R&&g&&p&&N)return[{id:"name",accessorKey:"name",header:"Ф.И.",size:180,cell:({row:s})=>e.jsx(ie,{className:"flex items-center px-1 w-max h-max leading-none",to:re(le.Users.Show,{id:s.original.id}),children:s.original.name}),meta:{columnClass:"flex items-center min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px]"}},...R.reduce((s,t)=>{if(t.length===13){const[,a]=t.split("_");s.push({id:t,accessorKey:t,header:se[+a],cell:({row:i})=>{const d=M==null?void 0:M[`${i.original.id}_${a}`];if(!d){let l=0,h=0,m=[];a==="93"?m=[...(n==null?void 0:n.data[91])||[],...(n==null?void 0:n.data[92])||[],...(n==null?void 0:n.data[93])||[]]:a==="96"?m=[...(n==null?void 0:n.data[94])||[],...(n==null?void 0:n.data[95])||[],...(n==null?void 0:n.data[96])||[]]:a==="97"?m=[...(n==null?void 0:n.data[91])||[],...(n==null?void 0:n.data[92])||[],...(n==null?void 0:n.data[93])||[],...(n==null?void 0:n.data[94])||[],...(n==null?void 0:n.data[95])||[],...(n==null?void 0:n.data[96])||[]]:m=(n==null?void 0:n.data[+a])||[],y==null||y.map(S=>{m!=null&&m.includes(S.lessonId)&&S.studentId===i.original.id&&(S.score1&&(l=l+S.score1,h=h+1),S.score2&&(l=l+S.score2,h=h+1))});const $=l/h||0;return e.jsx("button",{className:"flex justify-center items-center text-blue-200 min-w-9 min-h-9 cursor-pointer hover:bg-blue-50",type:"button",onClick:W({rating:Ce[+a],years:v,student_id:i.original.id,grade_id:+g,subject_id:+p},i.original.name),children:!["98","99"].includes(a)&&$.toFixed(2)||""})}return e.jsx("button",{className:"flex items-center justify-center min-w-9 min-h-9 cursor-pointer font-bold hover:bg-blue-50",type:"button",onClick:X({id:d.id,score:d.score},i.original.name),children:d.score})},meta:{columnClass:"flex items-center justify-end min-w-9 max-w-9 min-h-9 max-h-9"}})}else{const[a,,i]=t.split("_");s.push({id:t,accessorKey:t,header:a,size:40,cell:({row:d})=>{const l=N==null?void 0:N[`${d.original.id}_${i}`];return l?e.jsxs("button",{className:"flex items-center justify-center min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5",type:"button",onClick:Q({id:l.id,score_1:l.score1,score_2:l.score2,attendance:l.attendance,comment:l.comment},d.original.name),children:[l.score1,l.score1&&l.score2&&"/",l.score2,!l.score1&&!l.score2&&ke[l.attendance]]}):I(a)>I()?void 0:e.jsx("button",{className:"flex min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5",type:"button",onClick:q({attendance:"",lesson_id:+i,student_id:d.original.id},d.original.name)})},enableSorting:!1,meta:{columnClass:P("flex items-center justify-center min-w-9 max-w-9 min-h-9 max-h-9 border-r",I(a).format("YYYY-MM-DD")===I().format("YYYY-MM-DD")&&"!bg-green-50")}})}return s},[])]},[g,R,N,y,q,Q,W,X,n==null?void 0:n.data,M,p,v]);if(!(!g||!p))return!K||!Z?e.jsx(A,{className:"w-8 h-8"}):e.jsxs(e.Fragment,{children:[H&&e.jsx(Pe,{data:K,columns:Z,setLessons:f,lessonObject:H}),T&&e.jsx(o.Suspense,{fallback:e.jsx(A,{className:"w-8 h-8"}),children:e.jsx(De,{...T})}),Y&&e.jsx(o.Suspense,{fallback:e.jsx(A,{className:"w-8 h-8"}),children:e.jsx(Ae,{...Y})}),F&&e.jsx(o.Suspense,{fallback:e.jsx(A,{className:"w-8 h-8"}),children:e.jsx(Ie,{...F})}),U&&e.jsx(o.Suspense,{fallback:e.jsx(A,{className:"w-8 h-8"}),children:e.jsx(Te,{...U})})]})}const ze=o.memo(Ye);function O({className:x,inputClass:w,value:u,onChange:b,options:c,placeholder:p}){var f;const{ref:g,menuRef:v,isOpen:j,setIsOpen:_}=Ee();return e.jsxs("div",{ref:g,className:P(x,"relative flex flex-col"),children:[e.jsx("div",{className:"relative flex",children:e.jsx("button",{className:P("flex items-center min-h-8 max-h-8 grow bg-gray-50 min-w-0 border border-gray-200 rounded px-2 leading-none text-sm focus:outline-none hover:bg-gray-100 focus:border-primary focus:bg-gray-100 md:text-[16px]",!u&&"text-[#a8a3b7]",w),type:"button",onClick:r=>!r.target.classList.contains("remove-selection")&&_(!j),children:u?(f=c.find(r=>r.value===u))==null?void 0:f.label:p})}),e.jsx("div",{ref:v,className:P("absolute top-[calc(100%+4px)] right-0 z-10 border rounded-md pb-1 bg-white shadow-sm text-sm min-w-max w-full text-gray-500",j?"visible opacity-100":"invisible opacity-0"),children:e.jsx("ul",{className:"max-h-56 overflow-y-auto scrollbar-y",children:c.map(r=>e.jsx("li",{children:e.jsx("button",{className:"flex w-full items-center h-8 transition-all duration-150 hover:bg-green-50 px-3",type:"button",onClick:()=>{b(r.value),_(!1)},children:r.label})},r.value))})})]})}function Be(){const x=k(fe),w=k(be),[u,b]=te();return e.jsxs("header",{className:"relative z-50 flex gap-x-1 gap-y-1 items-end",children:[e.jsx("h1",{className:"title",children:"Журнал"}),e.jsx(O,{className:"min-w-10",placeholder:"Класс",options:(x||[]).map(c=>({value:c.id.toString(),label:`${c.level} ${c.group}`})),value:u.get("gradeId")||"",onChange:c=>b({subjectId:u.get("subjectId")||"",gradeId:c})}),e.jsx(O,{className:"grow max-w-[320px]",placeholder:"Предмет",options:(w||[]).map(c=>({value:c.id.toString(),label:c.name})),value:u.get("subjectId")||"",onChange:c=>b({gradeId:u.get("gradeId")||"",subjectId:c})})]})}const Ve=o.memo(Be);function Le(){const x=ee(),w=k(xe),u=k(ye),b=k(_e),c=k(he);return o.useEffect(()=>{w===z.Idle&&x(ce()),u===z.Idle&&x(de()),b===z.Idle&&x(me()),c===z.Idle&&x(ue())},[x,w,c,u,b]),e.jsxs("main",{className:"flex flex-col gap-y-1 py-2",children:[e.jsx(Ve,{}),e.jsx(ze,{})]})}export{Le as default};
