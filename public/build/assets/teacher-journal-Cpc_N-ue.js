const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lesson-edit-Bw7NOZmS.js","assets/main-Z-jcqNGw.js","assets/preload-helper-BfFHrpNk.js","assets/main-DNTo822Q.css","assets/icons-EbPIw1U1.js","assets/lessons-journal-edit-form-r0fCLqA0.js","assets/button-H3fW4CuH.js","assets/select-field-BuGouyWz.js","assets/cleanable-D1ZHZcsB.js","assets/formik.esm-CakdETH1.js","assets/use-dropdown-BpS_Hd_P.js","assets/index.browser-OxPLOBIU.js","assets/text-field-DY07PA3C.js","assets/lessons-selector-DizJGTgD.js"])))=>i.map(i=>d[i]);
import{r as o,t as E,j as a,c as k,S as K,a as W,u as C,p as X,ae as Q,af as Z,i as T,aj as L,ak as O,y as B,am as ee,L as te,X as se,A as ae,n as ne,C as ie,v as oe,W as re}from"./main-Z-jcqNGw.js";import{a as le,g as ce}from"./grades-selector-wdxGTWF8.js";import{b as me,a as ue,g as de}from"./ratings-selector-H04wyKyS.js";import{a as fe,g as xe}from"./subjects-selector-BfKUVZbP.js";import{a as pe,g as ge}from"./users-selector-Bz_QS4wi.js";import{b as q,a as G,c as he}from"./ratings-CKd6Gnpx.js";import{c as ye,g as be}from"./index-CWfm-2bf.js";import{_ as we}from"./preload-helper-BfFHrpNk.js";import{u as Se,c as je,f as ve}from"./index-B52krXrC.js";const _e=o.lazy(()=>we(()=>import("./lesson-edit-Bw7NOZmS.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])));function Ne({data:r,columns:y,setLessons:d,lessonObject:c}){const[S,f]=o.useState(),[x,M]=o.useState({left:["name"],right:[]}),R=Se({data:r,columns:y,getCoreRowModel:je(),state:{columnPinning:x},onColumnPinningChange:M}),$=o.useCallback(p=>l=>{const j=l.currentTarget.getBoundingClientRect(),h=j.top+80+4,A=j.left;f({dto:{id:p.id,topic:p.topic,homework:p.homework,type_id:p.typeId},position:{top:h,left:A},title:E(p.date).format("DD MMMM YYYY"),onClose:()=>f(void 0),onSuccess:P=>d((D=[])=>{const b=D.findIndex(w=>w.id===P.id);return b!==-1&&(D[b]=P),[...D]})})},[d]);return a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex flex-col rounded-md shadow border bg-white overflow-scroll max-h-[calc(100vh-52px)] styled-scrollbar text-sm md:text-[16px]",children:[a.jsx("div",{className:"sticky top-0 z-40 shadow min-w-max",children:R.getHeaderGroups().map(p=>a.jsxs("div",{className:"flex",children:[a.jsx("div",{className:"flex items-end leading-none justify-end p-1 min-w-7 max-w-7 font-semibold bg-gray-100 md:p-2 md:min-w-9 md:max-w-9",children:"№"}),p.headers.map(l=>l.id==="name"?a.jsx("div",{className:"flex items-end bg-gray-100 p-1 md:p-2 leading-none font-semibold min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px] min-h-20 max-h-20 sticky left-0 z-10 border-r",children:"Ф.И."},l.id):l.id.length===13?a.jsx("div",{className:"relative flex bg-gray-100 min-w-9 max-w-9 min-h-[80px] max-h-[80px] border-r text-[13px]",children:a.jsx("span",{className:"absolute left-full bottom-0 flex items-center justify-start px-1 origin-bottom-left -rotate-90 h-9 w-[80px] text-blue-600",children:q[+l.id.split("_")[1]]})},l.id):a.jsx("div",{className:"flex flex-col min-h-[80px] max-h-[80px] min-w-9 max-w-9",children:a.jsxs("button",{className:"relative flex items-center grow justify-center font-normal bg-gray-100 border-r cursor-pointer duration-150 hover:bg-gray-200",onClick:$(c[l.id]),children:[a.jsx("span",{className:"font-semibold mt-auto",children:l.id.split("_")[0].slice(-2)}),a.jsx("span",{className:"absolute left-0 top-[52px] origin-top-left -rotate-90 h-9 flex items-center w-12  text-sm",children:ye(E(l.id.split("_")[0]).format("MMM"))})]})},l.id))]},p.id))}),a.jsx("div",{className:"min-w-max",children:R.getRowModel().rows.map((p,l)=>a.jsxs("div",{className:k("flex",l%2?"bg-gray-50":"bg-white"),children:[a.jsxs("div",{className:k("flex items-center justify-end p-1 min-w-7 max-w-7 min-h-9 max-h-9 md:p-2 md:min-w-9 md:max-w-9",l%2?"bg-gray-50":"bg-white"),children:[l+1,"."]}),p.getVisibleCells().map((j,h)=>{var A;return a.jsx("div",{className:k(h===0&&"sticky left-0 border-r",l%2?"bg-gray-50 border-r":"bg-white border-r",(A=j.column.columnDef.meta)==null?void 0:A.columnClass),children:ve(j.column.columnDef.cell,j.getContext())},JSON.stringify(j))})]},p.original.id))})]}),S&&a.jsx(o.Suspense,{fallback:a.jsx(K,{className:"w-8 h-8"}),children:a.jsx(_e,{...S})})]})}const Ce=o.memo(Ne);function $e(){const r=W(),y=C(me),d=C(ue),c=C(pe),[S]=X(),f=S.get("subjectId"),x=S.get("gradeId"),M=be(),R=d==null?void 0:d.find(({years:t})=>t==M),[$,p]=o.useState(),[l,j]=o.useState(),[h,A]=o.useState(),[P,D]=o.useState();o.useEffect(()=>{f&&x&&(r(Q({subjectId:+f,gradeId:+x,onSuccess:t=>{p(t),r(Z({lessons:t.map(({id:e})=>e),onSuccess:e=>A(e)}))}})),y!==T.Loading&&r(L({years:M,subjectId:+f,gradeId:+x,onSuccess:t=>j(t)})))},[r,x,y,f,M]);const b=o.useMemo(()=>{const t={};if(l)return l.forEach(e=>{const n=`${e.studentId}_${G[e.rating]}`;t[n]=e}),t},[l]),w=o.useMemo(()=>{const t={};if(h)return h.forEach(e=>{const n=`${e.studentId}_${e.lessonId}`;t[n]=e}),t},[h]),F=o.useMemo(()=>{const t={};if($)return $.forEach(e=>{const n=`${e.date}_${e.hour}_${e.id}`;t[n]=e}),t},[$]),N=o.useMemo(()=>{if(R&&$){const t=$.map(e=>`${e.date}_${e.hour}_${e.id}`);return Object.entries(G).forEach(([e,n])=>{R[e]&&t.push(`${R[e]}_${n}`)}),t.sort(),t}},[R,$]),s=o.useMemo(()=>{if(N)return N.reduce((e,n)=>{if(n.length===13){const i=Number(n.split("_")[1]);e.data[i]=e.lessonIds,e.lessonIds=[]}else{const i=Number(n.split("_")[2]);e.lessonIds.push(i)}return e},{lessonIds:[],data:{}})},[N]),V=o.useMemo(()=>{if(N&&c&&x&&f&&h)return c.filter(t=>{var e;return((e=t.student)==null?void 0:e.gradeId)===+x}).map(t=>{const e=N.reduce((n,i)=>{if(i.length==13){const m=b==null?void 0:b[`${t.id}_${i.split("_")[1]}`];n[i]=m}else{const m=w==null?void 0:w[`${t.id}_${i.split("_")[2]}`];n[i]=m}return n},{});return{id:t.id,name:`${t.surname} ${t.name}`,...e}})},[x,N,w,h,b,f,c]),I=o.useCallback(t=>async e=>{const n=+e.target.value.trim();if(n&&n>=1&&n<=10&&n!==+e.target.defaultValue)e.target.classList.add("opacity-50"),t.score=n,await r(O({dto:t,onSuccess:i=>j((m=[])=>[...m,i]),onValidationError:i=>B.error(i.message),onFail:i=>B.success(i)})),e.target.classList.remove("opacity-50");else{e.target.value=e.target.defaultValue;return}},[r]),J=o.useCallback(t=>async e=>{const n=e.target.value.toLowerCase().trim();if(n==="н")t.attendance="A";else{const[i,m]=n.split(/ (.+)/),[u,g]=i.split("/");if(!(+u>=1&&+u<=10)){e.target.value="";return}if(g&&!(+g>=1&&+g<=10)){e.target.value="";return}t.score_1=+u,t.score_2=+g||void 0,t.comment=m==null?void 0:m.trim(),t.attendance="P"}e.target.classList.add("opacity-50"),await r(ee({dto:t,onSuccess:i=>A((m=[])=>[...m,i]),onFail:i=>B.success(i)})),e.target.classList.remove("opacity-50")},[r]),U=o.useMemo(()=>{if(N&&x&&f&&w)return[{id:"name",accessorKey:"name",header:"Ф.И.",size:180,cell:({row:t})=>a.jsx(te,{className:"flex items-center px-1 w-max h-max leading-none",to:se(ae.Users.Show,{id:t.original.id}),children:t.original.name}),meta:{columnClass:"flex items-center min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px]"}},...N.reduce((t,e)=>{if(e.length===13){const[,n]=e.split("_");t.push({id:e,accessorKey:e,header:q[+n],cell:({row:i})=>{const m=b==null?void 0:b[`${i.original.id}_${n}`];if(!m){let u=0,g=0,v=[];n==="93"?v=[...(s==null?void 0:s.data[91])||[],...(s==null?void 0:s.data[92])||[],...(s==null?void 0:s.data[93])||[]]:n==="96"?v=[...(s==null?void 0:s.data[94])||[],...(s==null?void 0:s.data[95])||[],...(s==null?void 0:s.data[96])||[]]:n==="97"?v=[...(s==null?void 0:s.data[91])||[],...(s==null?void 0:s.data[92])||[],...(s==null?void 0:s.data[93])||[],...(s==null?void 0:s.data[94])||[],...(s==null?void 0:s.data[95])||[],...(s==null?void 0:s.data[96])||[]]:v=(s==null?void 0:s.data[+n])||[],h==null||h.map(_=>{v!=null&&v.includes(_.lessonId)&&_.studentId===i.original.id&&(_.score1&&(u=u+_.score1,g=g+1),_.score2&&(u=u+_.score2,g=g+1))});const z=u/g||0,Y=!["98","99"].includes(n)&&z.toFixed(2)||"";return a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 cursor-pointer hover:bg-blue-50 bg-transparent focus:outline-0 text-blue-500 placeholder:text-blue-300",type:"number",onBlur:I({rating:he[+n],years:M,student_id:i.original.id,grade_id:+x,subject_id:+f}),placeholder:Y})}return a.jsx("div",{className:"flex items-center font-semibold text-blue-500 justify-center min-w-9 min-h-9",children:m.score})},meta:{columnClass:"flex items-center justify-end min-w-9 max-w-9 min-h-9 max-h-9"}})}else{const[n,,i]=e.split("_");t.push({id:e,accessorKey:e,header:n,size:40,cell:({row:m})=>{var v,z;const u=w==null?void 0:w[`${m.original.id}_${i}`];if(!u)return E(n)>E()?void 0:a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5 bg-transparent focus:outline-0",onBlur:J({attendance:"",lesson_id:+i,student_id:m.original.id})});let g="";if(u.score1||u.score2){const Y=((v=u.score1)==null?void 0:v.toString())??"",_=((z=u.score2)==null?void 0:z.toString())??"";g=Y&&_?`${Y}/${_}`:Y||_}else u.attendance==="A"&&(g="н");return a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5 bg-transparent focus:outline-0",onBlur:()=>D(void 0),onFocus:()=>D(u.comment),readOnly:!0,defaultValue:g})},enableSorting:!1,meta:{columnClass:k("flex items-center justify-center min-w-9 max-w-9 min-h-9 max-h-9 border-r",E(n).format("YYYY-MM-DD")===E().format("YYYY-MM-DD")&&"!bg-green-50")}})}return t},[])]},[x,N,w,h,J,I,s==null?void 0:s.data,b,f,M]);if(!(!x||!f))return!V||!U?a.jsx(K,{className:"w-8 h-8"}):a.jsxs(a.Fragment,{children:[F&&a.jsx(Ce,{data:V,columns:U,setLessons:p,lessonObject:F}),P&&a.jsx("div",{className:"fixed right-1 bottom-1 m-0 bg-white py-1 px-2 border",children:P})]})}const Me=o.memo($e);function H({className:r,inputClass:y,value:d,options:c,placeholder:S}){var f;return a.jsx("div",{className:k(r,"relative flex flex-col"),children:a.jsx("div",{className:"relative flex",children:a.jsx("button",{className:k("flex items-center min-h-8 max-h-8 grow bg-gray-50 min-w-0 border border-gray-200 rounded px-2 leading-none text-sm focus:outline-none hover:bg-gray-100 focus:border-primary focus:bg-gray-100 md:text-[16px]",!d&&"text-[#a8a3b7]",y),type:"button",children:d?(f=c.find(x=>x.value===d))==null?void 0:f.label:S})})})}function Re(){const r=C(le),y=C(fe),[d]=X();return a.jsxs("header",{className:"relative z-50 flex gap-x-1 gap-y-1 items-end",children:[a.jsx("h1",{className:"title",children:"Журнал"}),a.jsx(H,{className:"min-w-10",placeholder:"Класс",options:(r||[]).map(c=>({value:c.id.toString(),label:`${c.level} ${c.group}`})),value:d.get("gradeId")||""}),a.jsx(H,{className:"grow max-w-[320px]",placeholder:"Предмет",options:(y||[]).map(c=>({value:c.id.toString(),label:c.name})),value:d.get("subjectId")||""})]})}const Ae=o.memo(Re);function Ve(){const r=W(),y=C(ce),d=C(xe),c=C(ge),S=C(de);return o.useEffect(()=>{y===T.Idle&&r(ne()),d===T.Idle&&r(ie()),c===T.Idle&&r(oe()),S===T.Idle&&r(re())},[r,y,S,d,c]),a.jsxs("main",{className:"flex flex-col gap-y-1 py-2",children:[a.jsx(Ae,{}),a.jsx(Me,{})]})}export{Ve as default};
