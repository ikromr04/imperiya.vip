const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lesson-edit-BcKcX6V1.js","assets/main-DTCJiQsq.js","assets/preload-helper-DPi8upcZ.js","assets/main-CQojFZrT.css","assets/icons-B2aTwrz9.js","assets/lessons-journal-edit-form-DgQX_uGA.js","assets/button-ZbyXFrBi.js","assets/select-field-C-EaKXM3.js","assets/cleanable-D3GteXwV.js","assets/formik.esm-DmaS9LwQ.js","assets/use-dropdown-BewGSdNb.js","assets/index.browser-OxPLOBIU.js","assets/text-field-DtssmZdu.js","assets/lessons-selector-CRIKy2Lo.js","assets/rating-create-EkZEs1fj.js","assets/ratings-create-form-Syu5E5gk.js","assets/index.esm-COLkK52-.js","assets/rating-edit-CX7PVmq0.js","assets/mark-create-CCDPpgec.js","assets/marks-create-form-LI8DsP9l.js","assets/content-field-DlN10HYe.js","assets/marks-KWTxiGgr.js","assets/mark-edit-DLjd2doG.js"])))=>i.map(i=>d[i]);
import{r as n,q as N,j as e,c as I,S as $,u as X,a as v,o as ee,z as se,B as ne,h as T,a6 as ae,L as oe,v as ie,A as re,m as ce,w as le,x as de,Z as me}from"./main-DTCJiQsq.js";import{a as ue,g as ge}from"./grades-selector-fDFrO--I.js";import{b as te,c as xe,a as fe,d as Q,e as pe,g as he}from"./ratings-D7aUo8y0.js";import{a as be,g as je}from"./subjects-selector-BnU4oaie.js";import{a as ye,g as we}from"./users-selector-ClKCaFND.js";import{_ as z}from"./preload-helper-DPi8upcZ.js";import{c as _e,a as Ce}from"./index-CH9u_kY9.js";import{u as Se,c as ve,f as ke}from"./index-D-ibmixo.js";import{a as Re}from"./marks-KWTxiGgr.js";import{u as Ne}from"./use-dropdown-BewGSdNb.js";const Ie=n.lazy(()=>z(()=>import("./lesson-edit-BcKcX6V1.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])));function Ee({data:u,columns:p,setLessons:d,lessonObject:f}){const[c,g]=n.useState(),[x,w]=n.useState({left:["name"],right:[]}),y=Se({data:u,columns:p,getCoreRowModel:ve(),state:{columnPinning:x},onColumnPinningChange:w}),h=n.useCallback(m=>a=>{const b=a.currentTarget.getBoundingClientRect(),_=b.top+80+4,k=b.left;g({dto:{id:m.id,topic:m.topic,homework:m.homework,type_id:m.typeId},position:{top:_,left:k},title:N(m.date).format("DD MMMM YYYY"),onClose:()=>g(void 0),onSuccess:P=>d((E=[])=>{const D=E.findIndex(Y=>Y.id===P.id);return D!==-1&&(E[D]=P),[...E]})})},[d]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col rounded-md shadow border bg-white overflow-scroll max-h-[calc(100vh-52px)] styled-scrollbar text-sm md:text-[16px]",children:[e.jsx("div",{className:"sticky top-0 z-40 shadow min-w-max",children:y.getHeaderGroups().map(m=>e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex items-end leading-none justify-end p-1 min-w-7 max-w-7 font-semibold bg-gray-100 md:p-2 md:min-w-9 md:max-w-9",children:"№"}),m.headers.map(a=>a.id==="name"?e.jsx("div",{className:"flex items-end bg-gray-100 p-1 md:p-2 leading-none font-semibold min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px] min-h-20 max-h-20 sticky left-0 z-10 border-r",children:"Ф.И."},a.id):a.id.length===13?e.jsx("div",{className:"relative flex bg-gray-100 min-w-9 max-w-9 min-h-[80px] max-h-[80px] border-r text-[13px]",children:e.jsx("span",{className:"absolute left-full bottom-0 flex items-center justify-start px-1 origin-bottom-left -rotate-90 h-9 w-[80px] text-blue-600",children:te[+a.id.split("_")[1]]})},a.id):e.jsx("div",{className:"flex flex-col min-h-[80px] max-h-[80px] min-w-9 max-w-9",children:e.jsxs("button",{className:"relative flex items-center grow justify-center font-normal bg-gray-100 border-r cursor-pointer duration-150 hover:bg-gray-200",onClick:h(f[a.id]),children:[e.jsx("span",{className:"font-semibold mt-auto",children:a.id.split("_")[0].slice(-2)}),e.jsx("span",{className:"absolute left-0 top-[52px] origin-top-left -rotate-90 h-9 flex items-center w-12  text-sm",children:_e(N(a.id.split("_")[0]).format("MMM"))})]})},a.id))]},m.id))}),e.jsx("div",{className:"min-w-max",children:y.getRowModel().rows.map((m,a)=>e.jsxs("div",{className:I("flex",a%2?"bg-gray-50":"bg-white"),children:[e.jsxs("div",{className:I("flex items-center justify-end p-1 min-w-7 max-w-7 min-h-9 max-h-9 md:p-2 md:min-w-9 md:max-w-9",a%2?"bg-gray-50":"bg-white"),children:[a+1,"."]}),m.getVisibleCells().map((b,_)=>{var k;return e.jsx("div",{className:I(_===0&&"sticky left-0 border-r",a%2?"bg-gray-50 border-r":"bg-white border-r",(k=b.column.columnDef.meta)==null?void 0:k.columnClass),children:ke(b.column.columnDef.cell,b.getContext())},JSON.stringify(b))})]},m.original.id))})]}),c&&e.jsx(n.Suspense,{fallback:e.jsx($,{className:"w-8 h-8"}),children:e.jsx(Ie,{...c})})]})}const Me=n.memo(Ee),$e=n.lazy(()=>z(()=>import("./rating-create-EkZEs1fj.js"),__vite__mapDeps([14,1,2,3,4,15,16,6,9,12,8,11]))),Pe=n.lazy(()=>z(()=>import("./rating-edit-CX7PVmq0.js"),__vite__mapDeps([17,1,2,3,4,6,12,8,9,11]))),De=n.lazy(()=>z(()=>import("./mark-create-CCDPpgec.js"),__vite__mapDeps([18,1,2,3,4,19,16,6,20,8,9,7,10,11,21,12]))),Ae=n.lazy(()=>z(()=>import("./mark-edit-DLjd2doG.js"),__vite__mapDeps([22,1,2,3,4,6,20,8,9,7,10,11,12,21])));function Te(){const u=X(),p=v(xe),d=v(fe),f=v(ye),[c]=ee(),g=c.get("subjectId"),x=c.get("gradeId"),w=Ce(),y=d==null?void 0:d.find(({years:s})=>s==w),[h,m]=n.useState(),[a,b]=n.useState(),[_,k]=n.useState(),[P,E]=n.useState(),[D,Y]=n.useState(),[B,V]=n.useState(),[J,O]=n.useState();n.useEffect(()=>{g&&x&&(u(se({subjectId:+g,gradeId:+x,onSuccess:s=>{m(s),u(ne({lessons:s.map(({id:t})=>t),onSuccess:t=>k(t)}))}})),p!==T.Loading&&u(ae({years:w,subjectId:+g,gradeId:+x,onSuccess:s=>b(s)})))},[u,x,p,g,w]);const R=n.useMemo(()=>{const s={};if(a)return a.forEach(t=>{const i=`${t.studentId}_${Q[t.rating]}`;s[i]=t}),s},[a]),C=n.useMemo(()=>{const s={};if(_)return _.forEach(t=>{const i=`${t.studentId}_${t.lessonId}`;s[i]=t}),s},[_]),U=n.useMemo(()=>{const s={};if(h)return h.forEach(t=>{const i=`${t.date}_${t.hour}_${t.id}`;s[i]=t}),s},[h]),M=n.useMemo(()=>{if(y&&h){const s=h.map(t=>`${t.date}_${t.hour}_${t.id}`);return Object.entries(Q).forEach(([t,i])=>{y[t]&&s.push(`${y[t]}_${i}`)}),s.sort(),s}},[y,h]),F=n.useMemo(()=>{if(M&&f&&x&&g&&_)return f.filter(s=>{var t;return((t=s.student)==null?void 0:t.gradeId)===+x}).map(s=>{const t=M.reduce((i,r)=>{if(r.length==13){const l=R==null?void 0:R[`${s.id}_${r.split("_")[1]}`];i[r]=l}else{const l=C==null?void 0:C[`${s.id}_${r.split("_")[2]}`];i[r]=l}return i},{});return{id:s.id,name:`${s.surname} ${s.name}`,...t}})},[x,M,C,_,R,g,f]),G=n.useCallback((s,t)=>i=>{const r=i.currentTarget.getBoundingClientRect(),l=r.top+36+4,o=r.left+36+4;E({dto:s,position:{top:l,left:o},studentName:t,onClose:()=>E(void 0),onSuccess:S=>b((j=[])=>[...j,S])})},[]),H=n.useCallback((s,t)=>i=>{const r=i.currentTarget.getBoundingClientRect(),l=r.top+36+4,o=r.left+36+4;Y({dto:s,position:{top:l,left:o},studentName:t,onClose:()=>Y(void 0),onSuccess:S=>b((j=[])=>{const A=j.findIndex(L=>L.id===S.id);return A!==-1&&(j[A]=S),[...j]})})},[]),K=n.useCallback((s,t)=>i=>{const r=i.currentTarget.getBoundingClientRect(),l=r.top+36+4,o=r.left+36+4;V({dto:s,position:{top:l,left:o},studentName:t,onClose:()=>V(void 0),onSuccess:S=>k((j=[])=>[...j,S])})},[]),q=n.useCallback((s,t)=>i=>{const r=i.currentTarget.getBoundingClientRect(),l=r.top+36+4,o=r.left+36+4;O({dto:s,position:{top:l,left:o},studentName:t,onClose:()=>O(void 0),onSuccess:S=>k((j=[])=>{const A=j.findIndex(L=>L.id===S.id);return A!==-1&&(j[A]=S),[...j]})})},[]),Z=n.useMemo(()=>{if(M&&x&&g&&C)return[{id:"name",accessorKey:"name",header:"Ф.И.",size:180,cell:({row:s})=>e.jsx(oe,{className:"flex items-center px-1 w-max h-max leading-none",to:ie(re.Users.Show,{id:s.original.id}),children:s.original.name}),meta:{columnClass:"flex items-center min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px]"}},...M.reduce((s,t)=>{if(t.length===13){const[i,r]=t.split("_");s.push({id:t,accessorKey:t,header:te[+r],cell:({row:l})=>{const o=R==null?void 0:R[`${l.original.id}_${r}`];return o?e.jsx("button",{className:"flex items-center justify-center min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5",type:"button",onClick:H({id:o.id,score:o.score},l.original.name),children:o.score}):N(i)>N()?void 0:e.jsx("button",{className:"flex min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5",type:"button",onClick:G({rating:pe[+r],years:w,student_id:l.original.id,grade_id:+x,subject_id:+g},l.original.name)})},meta:{columnClass:"flex items-center justify-end min-w-9 max-w-9 min-h-9 max-h-9"}})}else{const[i,,r]=t.split("_");s.push({id:t,accessorKey:t,header:i,size:40,cell:({row:l})=>{const o=C==null?void 0:C[`${l.original.id}_${r}`];return o?e.jsxs("button",{className:"flex items-center justify-center min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5",type:"button",onClick:q({id:o.id,score_1:o.score1,score_2:o.score2,attendance:o.attendance,comment:o.comment},l.original.name),children:[o.score1,o.score1&&o.score2&&"/",o.score2,!o.score1&&!o.score2&&Re[o.attendance]]}):N(i)>N()?void 0:e.jsx("button",{className:"flex min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5",type:"button",onClick:K({attendance:"",lesson_id:+r,student_id:l.original.id},l.original.name)})},enableSorting:!1,meta:{columnClass:I("flex items-center justify-center min-w-9 max-w-9 min-h-9 max-h-9 border-r",N(i).format("YYYY-MM-DD")===N().format("YYYY-MM-DD")&&"!bg-green-50")}})}return s},[])]},[x,M,C,K,q,G,H,R,g,w]);if(!(!x||!g))return!F||!Z?e.jsx($,{className:"w-8 h-8"}):e.jsxs(e.Fragment,{children:[U&&e.jsx(Me,{data:F,columns:Z,setLessons:m,lessonObject:U}),P&&e.jsx(n.Suspense,{fallback:e.jsx($,{className:"w-8 h-8"}),children:e.jsx($e,{...P})}),D&&e.jsx(n.Suspense,{fallback:e.jsx($,{className:"w-8 h-8"}),children:e.jsx(Pe,{...D})}),B&&e.jsx(n.Suspense,{fallback:e.jsx($,{className:"w-8 h-8"}),children:e.jsx(De,{...B})}),J&&e.jsx(n.Suspense,{fallback:e.jsx($,{className:"w-8 h-8"}),children:e.jsx(Ae,{...J})})]})}const ze=n.memo(Te);function W({className:u,inputClass:p,value:d,onChange:f,options:c,placeholder:g}){var m;const{ref:x,menuRef:w,isOpen:y,setIsOpen:h}=Ne();return e.jsxs("div",{ref:x,className:I(u,"relative flex flex-col"),children:[e.jsx("div",{className:"relative flex",children:e.jsx("button",{className:I("flex items-center min-h-8 max-h-8 grow bg-gray-50 min-w-0 border border-gray-200 rounded px-2 leading-none text-sm focus:outline-none hover:bg-gray-100 focus:border-primary focus:bg-gray-100 md:text-[16px]",!d&&"text-[#a8a3b7]",p),type:"button",onClick:a=>!a.target.classList.contains("remove-selection")&&h(!y),children:d?(m=c.find(a=>a.value===d))==null?void 0:m.label:g})}),e.jsx("div",{ref:w,className:I("absolute top-[calc(100%+4px)] right-0 z-10 border rounded-md pb-1 bg-white shadow-sm text-sm min-w-max w-full text-gray-500",y?"visible opacity-100":"invisible opacity-0"),children:e.jsx("ul",{className:"max-h-56 overflow-y-auto scrollbar-y",children:c.map(a=>e.jsx("li",{children:e.jsx("button",{className:"flex w-full items-center h-8 transition-all duration-150 hover:bg-green-50 px-3",type:"button",onClick:()=>{f(a.value),h(!1)},children:a.label})},a.value))})})]})}function Ye(){const u=v(ue),p=v(be),[d,f]=ee();return e.jsxs("header",{className:"relative z-50 flex gap-x-1 gap-y-1 items-end",children:[e.jsx("h1",{className:"title",children:"Журнал"}),e.jsx(W,{className:"min-w-10",placeholder:"Класс",options:(u||[]).map(c=>({value:c.id.toString(),label:`${c.level} ${c.group}`})),value:d.get("gradeId")||"",onChange:c=>f({subjectId:d.get("subjectId")||"",gradeId:c})}),e.jsx(W,{className:"grow max-w-[320px]",placeholder:"Предмет",options:(p||[]).map(c=>({value:c.id.toString(),label:c.name})),value:d.get("subjectId")||"",onChange:c=>f({gradeId:d.get("gradeId")||"",subjectId:c})})]})}const Le=n.memo(Ye);function Ze(){const u=X(),p=v(ge),d=v(je),f=v(we),c=v(he);return n.useEffect(()=>{p===T.Idle&&u(ce()),d===T.Idle&&u(le()),f===T.Idle&&u(de()),c===T.Idle&&u(me())},[u,p,c,d,f]),e.jsxs("main",{className:"flex flex-col gap-y-1 py-2",children:[e.jsx(Le,{}),e.jsx(ze,{})]})}export{Ze as default};
