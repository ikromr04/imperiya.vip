const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lesson-edit-BivLFlmt.js","assets/main-DLHcp_34.js","assets/preload-helper-DPi8upcZ.js","assets/main-Bd0mlOr_.css","assets/icons-OdLsuZAu.js","assets/lessons-journal-edit-form-MieOwPg0.js","assets/button-Bb1-8EaV.js","assets/select-field-CATDDC1n.js","assets/cleanable-Ndm0y06g.js","assets/formik.esm-D9UO8hfm.js","assets/use-dropdown-BLYuosyC.js","assets/index.browser-OxPLOBIU.js","assets/text-field-JQl_BxZn.js","assets/lessons-selector-BHtJUZ-s.js","assets/rating-create-0AuqxO2Z.js","assets/ratings-create-form-BYeltGns.js","assets/index.esm-BIj9INg2.js","assets/rating-edit-CrPwOp3g.js","assets/mark-create-ZL7TY2t8.js","assets/marks-create-form-DWUahBJr.js","assets/content-field-QhCls8Lr.js","assets/marks-KWTxiGgr.js","assets/mark-edit-gBs3BAQa.js"])))=>i.map(i=>d[i]);
import{r as n,q as A,j as e,c as M,S as D,u as ee,a as I,o as te,z as ne,B as ae,h as Y,a6 as oe,L as ie,v as re,A as ce,m as le,w as de,x as me,Z as ue}from"./main-DLHcp_34.js";import{a as ge,g as xe}from"./grades-selector-BzUEWiWt.js";import{b as se,c as fe,a as pe,d as W,e as he,g as be}from"./ratings-emt1vHPP.js";import{a as je,g as ye}from"./subjects-selector-4Lo3Op8w.js";import{a as we,g as _e}from"./users-selector-PkA7Q9gb.js";import{_ as B}from"./preload-helper-DPi8upcZ.js";import{c as Ce,a as Se}from"./index-mapehrYe.js";import{u as ve,c as Ie,f as Ne}from"./index-W2lbxK5C.js";import{a as Re}from"./marks-KWTxiGgr.js";import{u as ke}from"./use-dropdown-BLYuosyC.js";const Ee=n.lazy(()=>B(()=>import("./lesson-edit-BivLFlmt.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])));function Me({data:u,columns:j,setLessons:d,lessonObject:p}){const[c,g]=n.useState(),[x,C]=n.useState({left:["name"],right:[]}),_=ve({data:u,columns:j,getCoreRowModel:Ie(),state:{columnPinning:x},onColumnPinningChange:C}),y=n.useCallback(m=>i=>{const w=i.currentTarget.getBoundingClientRect(),h=w.top+80+4,N=w.left;g({dto:{id:m.id,topic:m.topic,homework:m.homework,type_id:m.typeId},position:{top:h,left:N},title:A(m.date).format("DD MMMM YYYY"),onClose:()=>g(void 0),onSuccess:T=>d(($=[])=>{const z=$.findIndex(L=>L.id===T.id);return z!==-1&&($[z]=T),[...$]})})},[d]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col rounded-md shadow border bg-white overflow-scroll max-h-[calc(100vh-52px)] styled-scrollbar text-sm md:text-[16px]",children:[e.jsx("div",{className:"sticky top-0 z-40 shadow min-w-max",children:_.getHeaderGroups().map(m=>e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex items-end leading-none justify-end p-1 min-w-7 max-w-7 font-semibold bg-gray-100 md:p-2 md:min-w-9 md:max-w-9",children:"№"}),m.headers.map(i=>i.id==="name"?e.jsx("div",{className:"flex items-end bg-gray-100 p-1 md:p-2 leading-none font-semibold min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px] min-h-20 max-h-20 sticky left-0 z-10 border-r",children:"Ф.И."},i.id):i.id.length===13?e.jsx("div",{className:"relative flex bg-gray-100 min-w-9 max-w-9 min-h-[80px] max-h-[80px] border-r text-[13px]",children:e.jsx("span",{className:"absolute left-full bottom-0 flex items-center justify-start px-1 origin-bottom-left -rotate-90 h-9 w-[80px] text-blue-600",children:se[+i.id.split("_")[1]]})},i.id):e.jsx("div",{className:"flex flex-col min-h-[80px] max-h-[80px] min-w-9 max-w-9",children:e.jsxs("button",{className:"relative flex items-center grow justify-center font-normal bg-gray-100 border-r cursor-pointer duration-150 hover:bg-gray-200",onClick:y(p[i.id]),children:[e.jsx("span",{className:"font-semibold mt-auto",children:i.id.split("_")[0].slice(-2)}),e.jsx("span",{className:"absolute left-0 top-[52px] origin-top-left -rotate-90 h-9 flex items-center w-12  text-sm",children:Ce(A(i.id.split("_")[0]).format("MMM"))})]})},i.id))]},m.id))}),e.jsx("div",{className:"min-w-max",children:_.getRowModel().rows.map((m,i)=>e.jsxs("div",{className:M("flex",i%2?"bg-gray-50":"bg-white"),children:[e.jsxs("div",{className:M("flex items-center justify-end p-1 min-w-7 max-w-7 min-h-9 max-h-9 md:p-2 md:min-w-9 md:max-w-9",i%2?"bg-gray-50":"bg-white"),children:[i+1,"."]}),m.getVisibleCells().map((w,h)=>{var N;return e.jsx("div",{className:M(h===0&&"sticky left-0 border-r",i%2?"bg-gray-50 border-r":"bg-white border-r",(N=w.column.columnDef.meta)==null?void 0:N.columnClass),children:Ne(w.column.columnDef.cell,w.getContext())},JSON.stringify(w))})]},m.original.id))})]}),c&&e.jsx(n.Suspense,{fallback:e.jsx(D,{className:"w-8 h-8"}),children:e.jsx(Ee,{...c})})]})}const $e=n.memo(Me),Pe=n.lazy(()=>B(()=>import("./rating-create-0AuqxO2Z.js"),__vite__mapDeps([14,1,2,3,4,15,16,6,9,12,8,11]))),De=n.lazy(()=>B(()=>import("./rating-edit-CrPwOp3g.js"),__vite__mapDeps([17,1,2,3,4,6,12,8,9,11]))),Ae=n.lazy(()=>B(()=>import("./mark-create-ZL7TY2t8.js"),__vite__mapDeps([18,1,2,3,4,19,16,6,20,8,9,7,10,11,21,12]))),Te=n.lazy(()=>B(()=>import("./mark-edit-gBs3BAQa.js"),__vite__mapDeps([22,1,2,3,4,6,20,8,9,7,10,11,12,21])));function ze(){const u=ee(),j=I(fe),d=I(pe),p=I(we),[c]=te(),g=c.get("subjectId"),x=c.get("gradeId"),C=Se(),_=d==null?void 0:d.find(({years:s})=>s==C),[y,m]=n.useState(),[i,w]=n.useState(),[h,N]=n.useState(),[T,$]=n.useState(),[z,L]=n.useState(),[V,J]=n.useState(),[U,F]=n.useState();n.useEffect(()=>{g&&x&&(u(ne({subjectId:+g,gradeId:+x,onSuccess:s=>{m(s),u(ae({lessons:s.map(({id:t})=>t),onSuccess:t=>N(t)}))}})),j!==Y.Loading&&u(oe({years:C,subjectId:+g,gradeId:+x,onSuccess:s=>w(s)})))},[u,x,j,g,C]);const R=n.useMemo(()=>{const s={};if(i)return i.forEach(t=>{const a=`${t.studentId}_${W[t.rating]}`;s[a]=t}),s},[i]),S=n.useMemo(()=>{const s={};if(h)return h.forEach(t=>{const a=`${t.studentId}_${t.lessonId}`;s[a]=t}),s},[h]),G=n.useMemo(()=>{const s={};if(y)return y.forEach(t=>{const a=`${t.date}_${t.hour}_${t.id}`;s[a]=t}),s},[y]),v=n.useMemo(()=>{if(_&&y){const s=y.map(t=>`${t.date}_${t.hour}_${t.id}`);return Object.entries(W).forEach(([t,a])=>{_[t]&&s.push(`${_[t]}_${a}`)}),s.sort(),s}},[_,y]),P=n.useMemo(()=>{if(v)return v.reduce((t,a)=>{if(a.length===13){const o=Number(a.split("_")[1]);t.data[o]=t.lessonIds,t.lessonIds=[]}else{const o=Number(a.split("_")[2]);t.lessonIds.push(o)}return t},{lessonIds:[],data:{}})},[v]),H=n.useMemo(()=>{if(v&&p&&x&&g&&h)return p.filter(s=>{var t;return((t=s.student)==null?void 0:t.gradeId)===+x}).map(s=>{const t=v.reduce((a,o)=>{if(o.length==13){const l=R==null?void 0:R[`${s.id}_${o.split("_")[1]}`];a[o]=l}else{const l=S==null?void 0:S[`${s.id}_${o.split("_")[2]}`];a[o]=l}return a},{});return{id:s.id,name:`${s.surname} ${s.name}`,...t}})},[x,v,S,h,R,g,p]),K=n.useCallback((s,t)=>a=>{const o=a.currentTarget.getBoundingClientRect(),l=o.top+36+4,r=o.left+36+4;$({dto:s,position:{top:l,left:r},studentName:t,onClose:()=>$(void 0),onSuccess:b=>w((f=[])=>[...f,b])})},[]),q=n.useCallback((s,t)=>a=>{const o=a.currentTarget.getBoundingClientRect(),l=o.top+36+4,r=o.left+36+4;L({dto:s,position:{top:l,left:r},studentName:t,onClose:()=>L(void 0),onSuccess:b=>w((f=[])=>{const E=f.findIndex(k=>k.id===b.id);return E!==-1&&(f[E]=b),[...f]})})},[]),O=n.useCallback((s,t)=>a=>{const o=a.currentTarget.getBoundingClientRect(),l=o.top+36+4,r=o.left+36+4;J({dto:s,position:{top:l,left:r},studentName:t,onClose:()=>J(void 0),onSuccess:b=>N((f=[])=>[...f,b])})},[]),Z=n.useCallback((s,t)=>a=>{const o=a.currentTarget.getBoundingClientRect(),l=o.top+36+4,r=o.left+36+4;F({dto:s,position:{top:l,left:r},studentName:t,onClose:()=>F(void 0),onSuccess:b=>N((f=[])=>{const E=f.findIndex(k=>k.id===b.id);return E!==-1&&(f[E]=b),[...f]})})},[]),Q=n.useMemo(()=>{if(v&&x&&g&&S)return[{id:"name",accessorKey:"name",header:"Ф.И.",size:180,cell:({row:s})=>e.jsx(ie,{className:"flex items-center px-1 w-max h-max leading-none",to:re(ce.Users.Show,{id:s.original.id}),children:s.original.name}),meta:{columnClass:"flex items-center min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px]"}},...v.reduce((s,t)=>{if(t.length===13){const[,a]=t.split("_");s.push({id:t,accessorKey:t,header:se[+a],cell:({row:o})=>{const l=R==null?void 0:R[`${o.original.id}_${a}`];if(!l){const r=P==null?void 0:P.data[+a];let b=0,f=0;h==null||h.map(k=>{r!=null&&r.includes(k.lessonId)&&k.studentId===o.original.id&&k.score1&&(b=b+k.score1,f=f+1)});const E=b/f||0;return e.jsx("button",{className:"flex justify-center items-center text-blue-200 min-w-9 min-h-9 cursor-pointer hover:bg-blue-50",type:"button",onClick:K({rating:he[+a],years:C,student_id:o.original.id,grade_id:+x,subject_id:+g},o.original.name),children:E||""})}return e.jsx("button",{className:"flex items-center justify-center min-w-9 min-h-9 cursor-pointer font-bold hover:bg-blue-50",type:"button",onClick:q({id:l.id,score:l.score},o.original.name),children:l.score})},meta:{columnClass:"flex items-center justify-end min-w-9 max-w-9 min-h-9 max-h-9"}})}else{const[a,,o]=t.split("_");s.push({id:t,accessorKey:t,header:a,size:40,cell:({row:l})=>{const r=S==null?void 0:S[`${l.original.id}_${o}`];return r?e.jsxs("button",{className:"flex items-center justify-center min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5",type:"button",onClick:Z({id:r.id,score_1:r.score1,score_2:r.score2,attendance:r.attendance,comment:r.comment},l.original.name),children:[r.score1,r.score1&&r.score2&&"/",r.score2,!r.score1&&!r.score2&&Re[r.attendance]]}):A(a)>A()?void 0:e.jsx("button",{className:"flex min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5",type:"button",onClick:O({attendance:"",lesson_id:+o,student_id:l.original.id},l.original.name)})},enableSorting:!1,meta:{columnClass:M("flex items-center justify-center min-w-9 max-w-9 min-h-9 max-h-9 border-r",A(a).format("YYYY-MM-DD")===A().format("YYYY-MM-DD")&&"!bg-green-50")}})}return s},[])]},[x,v,S,h,O,Z,K,q,P==null?void 0:P.data,R,g,C]);if(!(!x||!g))return!H||!Q?e.jsx(D,{className:"w-8 h-8"}):e.jsxs(e.Fragment,{children:[G&&e.jsx($e,{data:H,columns:Q,setLessons:m,lessonObject:G}),T&&e.jsx(n.Suspense,{fallback:e.jsx(D,{className:"w-8 h-8"}),children:e.jsx(Pe,{...T})}),z&&e.jsx(n.Suspense,{fallback:e.jsx(D,{className:"w-8 h-8"}),children:e.jsx(De,{...z})}),V&&e.jsx(n.Suspense,{fallback:e.jsx(D,{className:"w-8 h-8"}),children:e.jsx(Ae,{...V})}),U&&e.jsx(n.Suspense,{fallback:e.jsx(D,{className:"w-8 h-8"}),children:e.jsx(Te,{...U})})]})}const Ye=n.memo(ze);function X({className:u,inputClass:j,value:d,onChange:p,options:c,placeholder:g}){var m;const{ref:x,menuRef:C,isOpen:_,setIsOpen:y}=ke();return e.jsxs("div",{ref:x,className:M(u,"relative flex flex-col"),children:[e.jsx("div",{className:"relative flex",children:e.jsx("button",{className:M("flex items-center min-h-8 max-h-8 grow bg-gray-50 min-w-0 border border-gray-200 rounded px-2 leading-none text-sm focus:outline-none hover:bg-gray-100 focus:border-primary focus:bg-gray-100 md:text-[16px]",!d&&"text-[#a8a3b7]",j),type:"button",onClick:i=>!i.target.classList.contains("remove-selection")&&y(!_),children:d?(m=c.find(i=>i.value===d))==null?void 0:m.label:g})}),e.jsx("div",{ref:C,className:M("absolute top-[calc(100%+4px)] right-0 z-10 border rounded-md pb-1 bg-white shadow-sm text-sm min-w-max w-full text-gray-500",_?"visible opacity-100":"invisible opacity-0"),children:e.jsx("ul",{className:"max-h-56 overflow-y-auto scrollbar-y",children:c.map(i=>e.jsx("li",{children:e.jsx("button",{className:"flex w-full items-center h-8 transition-all duration-150 hover:bg-green-50 px-3",type:"button",onClick:()=>{p(i.value),y(!1)},children:i.label})},i.value))})})]})}function Be(){const u=I(ge),j=I(je),[d,p]=te();return e.jsxs("header",{className:"relative z-50 flex gap-x-1 gap-y-1 items-end",children:[e.jsx("h1",{className:"title",children:"Журнал"}),e.jsx(X,{className:"min-w-10",placeholder:"Класс",options:(u||[]).map(c=>({value:c.id.toString(),label:`${c.level} ${c.group}`})),value:d.get("gradeId")||"",onChange:c=>p({subjectId:d.get("subjectId")||"",gradeId:c})}),e.jsx(X,{className:"grow max-w-[320px]",placeholder:"Предмет",options:(j||[]).map(c=>({value:c.id.toString(),label:c.name})),value:d.get("subjectId")||"",onChange:c=>p({gradeId:d.get("gradeId")||"",subjectId:c})})]})}const Le=n.memo(Be);function Qe(){const u=ee(),j=I(xe),d=I(ye),p=I(_e),c=I(be);return n.useEffect(()=>{j===Y.Idle&&u(le()),d===Y.Idle&&u(de()),p===Y.Idle&&u(me()),c===Y.Idle&&u(ue())},[u,j,c,d,p]),e.jsxs("main",{className:"flex flex-col gap-y-1 py-2",children:[e.jsx(Le,{}),e.jsx(Ye,{})]})}export{Qe as default};
