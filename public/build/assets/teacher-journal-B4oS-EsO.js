const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lesson-edit-CqI2ZXmc.js","assets/main-ConWnhM4.js","assets/preload-helper-BfFHrpNk.js","assets/main-CZMWdHFf.css","assets/icons-DmwnT1ee.js","assets/lessons-journal-edit-form-DEjcl0n0.js","assets/button-CKVFwUw_.js","assets/select-field-Dg8p0W41.js","assets/cleanable-D8kac7Ju.js","assets/formik.esm-BOr-EtKd.js","assets/use-dropdown-dRrjbPrc.js","assets/index.browser-OxPLOBIU.js","assets/text-field-BxtQOttf.js","assets/lessons-selector-1kQVBtX7.js","assets/rating-create-DlgfgCLH.js","assets/ratings-create-form-tBbzejZb.js","assets/index.esm-C5LzmXqC.js","assets/mark-create-D6sZVZ7r.js","assets/marks-create-form-Bn5EVs6t.js","assets/content-field-B5SMbO2S.js","assets/marks-KWTxiGgr.js"])))=>i.map(i=>d[i]);
import{r as o,t as E,j as t,c as P,S as B,a as W,u as j,p as X,ae as Z,af as L,i as Y,aj as O,L as ee,X as te,A as se,n as ae,C as ne,v as oe,W as ie}from"./main-ConWnhM4.js";import{a as re,g as le}from"./grades-selector-C8NliX7u.js";import{b as ce,a as me,g as de}from"./ratings-selector-UCbxjsXm.js";import{a as ue,g as fe}from"./subjects-selector-BaIeqCgX.js";import{a as xe,g as pe}from"./users-selector-BQg7DqyW.js";import{_ as F}from"./preload-helper-BfFHrpNk.js";import{b as q,a as H,c as ge}from"./ratings-CKd6Gnpx.js";import{c as he,g as be}from"./index-DDZONCzz.js";import{u as we,c as ye,f as Se}from"./index-BP2IkD7y.js";import{a as _e}from"./marks-KWTxiGgr.js";const Ce=o.lazy(()=>F(()=>import("./lesson-edit-CqI2ZXmc.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])));function je({data:m,columns:h,setLessons:d,lessonObject:c}){const[w,u]=o.useState(),[f,R]=o.useState({left:["name"],right:[]}),M=we({data:m,columns:h,getCoreRowModel:ye(),state:{columnPinning:f},onColumnPinningChange:R}),v=o.useCallback(x=>r=>{const y=r.currentTarget.getBoundingClientRect(),g=y.top+80+4,$=y.left;u({dto:{id:x.id,topic:x.topic,homework:x.homework,type_id:x.typeId},position:{top:g,left:$},title:E(x.date).format("DD MMMM YYYY"),onClose:()=>u(void 0),onSuccess:A=>d((k=[])=>{const T=k.findIndex(z=>z.id===A.id);return T!==-1&&(k[T]=A),[...k]})})},[d]);return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex flex-col rounded-md shadow border bg-white overflow-scroll max-h-[calc(100vh-52px)] styled-scrollbar text-sm md:text-[16px]",children:[t.jsx("div",{className:"sticky top-0 z-40 shadow min-w-max",children:M.getHeaderGroups().map(x=>t.jsxs("div",{className:"flex",children:[t.jsx("div",{className:"flex items-end leading-none justify-end p-1 min-w-7 max-w-7 font-semibold bg-gray-100 md:p-2 md:min-w-9 md:max-w-9",children:"№"}),x.headers.map(r=>r.id==="name"?t.jsx("div",{className:"flex items-end bg-gray-100 p-1 md:p-2 leading-none font-semibold min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px] min-h-20 max-h-20 sticky left-0 z-10 border-r",children:"Ф.И."},r.id):r.id.length===13?t.jsx("div",{className:"relative flex bg-gray-100 min-w-9 max-w-9 min-h-[80px] max-h-[80px] border-r text-[13px]",children:t.jsx("span",{className:"absolute left-full bottom-0 flex items-center justify-start px-1 origin-bottom-left -rotate-90 h-9 w-[80px] text-blue-600",children:q[+r.id.split("_")[1]]})},r.id):t.jsx("div",{className:"flex flex-col min-h-[80px] max-h-[80px] min-w-9 max-w-9",children:t.jsxs("button",{className:"relative flex items-center grow justify-center font-normal bg-gray-100 border-r cursor-pointer duration-150 hover:bg-gray-200",onClick:v(c[r.id]),children:[t.jsx("span",{className:"font-semibold mt-auto",children:r.id.split("_")[0].slice(-2)}),t.jsx("span",{className:"absolute left-0 top-[52px] origin-top-left -rotate-90 h-9 flex items-center w-12  text-sm",children:he(E(r.id.split("_")[0]).format("MMM"))})]})},r.id))]},x.id))}),t.jsx("div",{className:"min-w-max",children:M.getRowModel().rows.map((x,r)=>t.jsxs("div",{className:P("flex",r%2?"bg-gray-50":"bg-white"),children:[t.jsxs("div",{className:P("flex items-center justify-end p-1 min-w-7 max-w-7 min-h-9 max-h-9 md:p-2 md:min-w-9 md:max-w-9",r%2?"bg-gray-50":"bg-white"),children:[r+1,"."]}),x.getVisibleCells().map((y,g)=>{var $;return t.jsx("div",{className:P(g===0&&"sticky left-0 border-r",r%2?"bg-gray-50 border-r":"bg-white border-r",($=y.column.columnDef.meta)==null?void 0:$.columnClass),children:Se(y.column.columnDef.cell,y.getContext())},JSON.stringify(y))})]},x.original.id))})]}),w&&t.jsx(o.Suspense,{fallback:t.jsx(B,{className:"w-8 h-8"}),children:t.jsx(Ce,{...w})})]})}const ve=o.memo(je),Ne=o.lazy(()=>F(()=>import("./rating-create-DlgfgCLH.js"),__vite__mapDeps([14,1,2,3,4,15,16,6,9,12,8,11]))),Re=o.lazy(()=>F(()=>import("./mark-create-D6sZVZ7r.js"),__vite__mapDeps([17,1,2,3,4,18,16,6,19,8,9,7,10,11,20,12])));function Me(){const m=W(),h=j(ce),d=j(me),c=j(xe),[w]=X(),u=w.get("subjectId"),f=w.get("gradeId"),R=be(),M=d==null?void 0:d.find(({years:a})=>a==R),[v,x]=o.useState(),[r,y]=o.useState(),[g,$]=o.useState(),[A,k]=o.useState(),[T,z]=o.useState();o.useEffect(()=>{u&&f&&(m(Z({subjectId:+u,gradeId:+f,onSuccess:a=>{x(a),m(L({lessons:a.map(({id:e})=>e),onSuccess:e=>$(e)}))}})),h!==Y.Loading&&m(O({years:R,subjectId:+u,gradeId:+f,onSuccess:a=>y(a)})))},[m,f,h,u,R]);const N=o.useMemo(()=>{const a={};if(r)return r.forEach(e=>{const n=`${e.studentId}_${H[e.rating]}`;a[n]=e}),a},[r]),S=o.useMemo(()=>{const a={};if(g)return g.forEach(e=>{const n=`${e.studentId}_${e.lessonId}`;a[n]=e}),a},[g]),I=o.useMemo(()=>{const a={};if(v)return v.forEach(e=>{const n=`${e.date}_${e.hour}_${e.id}`;a[n]=e}),a},[v]),_=o.useMemo(()=>{if(M&&v){const a=v.map(e=>`${e.date}_${e.hour}_${e.id}`);return Object.entries(H).forEach(([e,n])=>{M[e]&&a.push(`${M[e]}_${n}`)}),a.sort(),a}},[M,v]),s=o.useMemo(()=>{if(_)return _.reduce((e,n)=>{if(n.length===13){const i=Number(n.split("_")[1]);e.data[i]=e.lessonIds,e.lessonIds=[]}else{const i=Number(n.split("_")[2]);e.lessonIds.push(i)}return e},{lessonIds:[],data:{}})},[_]),J=o.useMemo(()=>{if(_&&c&&f&&u&&g)return c.filter(a=>{var e;return((e=a.student)==null?void 0:e.gradeId)===+f}).map(a=>{const e=_.reduce((n,i)=>{if(i.length==13){const p=N==null?void 0:N[`${a.id}_${i.split("_")[1]}`];n[i]=p}else{const p=S==null?void 0:S[`${a.id}_${i.split("_")[2]}`];n[i]=p}return n},{});return{id:a.id,name:`${a.surname} ${a.name}`,...e}})},[f,_,S,g,N,u,c]),U=o.useCallback((a,e)=>n=>{const i=n.currentTarget.getBoundingClientRect(),p=i.top+36+4,l=i.left+36+4;k({dto:a,position:{top:p,left:l},studentName:e,onClose:()=>k(void 0),onSuccess:C=>y((b=[])=>[...b,C])})},[]),V=o.useCallback((a,e)=>n=>{const i=n.currentTarget.getBoundingClientRect(),p=i.top+36+4,l=i.left+36+4;z({dto:a,position:{top:p,left:l},studentName:e,onClose:()=>z(void 0),onSuccess:C=>$((b=[])=>[...b,C])})},[]),G=o.useMemo(()=>{if(_&&f&&u&&S)return[{id:"name",accessorKey:"name",header:"Ф.И.",size:180,cell:({row:a})=>t.jsx(ee,{className:"flex items-center px-1 w-max h-max leading-none",to:te(se.Users.Show,{id:a.original.id}),children:a.original.name}),meta:{columnClass:"flex items-center min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px]"}},..._.reduce((a,e)=>{if(e.length===13){const[,n]=e.split("_");a.push({id:e,accessorKey:e,header:q[+n],cell:({row:i})=>{const p=N==null?void 0:N[`${i.original.id}_${n}`];if(!p){let l=0,C=0,b=[];n==="93"?b=[...(s==null?void 0:s.data[91])||[],...(s==null?void 0:s.data[92])||[],...(s==null?void 0:s.data[93])||[]]:n==="96"?b=[...(s==null?void 0:s.data[94])||[],...(s==null?void 0:s.data[95])||[],...(s==null?void 0:s.data[96])||[]]:n==="97"?b=[...(s==null?void 0:s.data[91])||[],...(s==null?void 0:s.data[92])||[],...(s==null?void 0:s.data[93])||[],...(s==null?void 0:s.data[94])||[],...(s==null?void 0:s.data[95])||[],...(s==null?void 0:s.data[96])||[]]:b=(s==null?void 0:s.data[+n])||[],g==null||g.map(D=>{b!=null&&b.includes(D.lessonId)&&D.studentId===i.original.id&&(D.score1&&(l=l+D.score1,C=C+1),D.score2&&(l=l+D.score2,C=C+1))});const Q=l/C||0;return t.jsx("button",{className:"flex justify-center items-center text-blue-200 min-w-9 min-h-9 cursor-pointer hover:bg-blue-50",type:"button",onClick:U({rating:ge[+n],years:R,student_id:i.original.id,grade_id:+f,subject_id:+u},i.original.name),children:!["98","99"].includes(n)&&Q.toFixed(2)||""})}return t.jsx("div",{className:"flex items-center justify-center min-w-9 min-h-9",children:p.score})},meta:{columnClass:"flex items-center justify-end min-w-9 max-w-9 min-h-9 max-h-9"}})}else{const[n,,i]=e.split("_");a.push({id:e,accessorKey:e,header:n,size:40,cell:({row:p})=>{const l=S==null?void 0:S[`${p.original.id}_${i}`];return l?t.jsxs("div",{className:"flex items-center justify-center min-w-9 min-h-9",children:[l.score1,l.score1&&l.score2&&"/",l.score2,!l.score1&&!l.score2&&_e[l.attendance]]}):E(n)>E()?void 0:t.jsx("button",{className:"flex min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5",type:"button",onClick:V({attendance:"",lesson_id:+i,student_id:p.original.id},p.original.name)})},enableSorting:!1,meta:{columnClass:P("flex items-center justify-center min-w-9 max-w-9 min-h-9 max-h-9 border-r",E(n).format("YYYY-MM-DD")===E().format("YYYY-MM-DD")&&"!bg-green-50")}})}return a},[])]},[f,_,S,g,V,U,s==null?void 0:s.data,N,u,R]);if(!(!f||!u))return!J||!G?t.jsx(B,{className:"w-8 h-8"}):t.jsxs(t.Fragment,{children:[I&&t.jsx(ve,{data:J,columns:G,setLessons:x,lessonObject:I}),A&&t.jsx(o.Suspense,{fallback:t.jsx(B,{className:"w-8 h-8"}),children:t.jsx(Ne,{...A})}),T&&t.jsx(o.Suspense,{fallback:t.jsx(B,{className:"w-8 h-8"}),children:t.jsx(Re,{...T})})]})}const $e=o.memo(Me);function K({className:m,inputClass:h,value:d,options:c,placeholder:w}){var u;return t.jsx("div",{className:P(m,"relative flex flex-col"),children:t.jsx("div",{className:"relative flex",children:t.jsx("button",{className:P("flex items-center min-h-8 max-h-8 grow bg-gray-50 min-w-0 border border-gray-200 rounded px-2 leading-none text-sm focus:outline-none hover:bg-gray-100 focus:border-primary focus:bg-gray-100 md:text-[16px]",!d&&"text-[#a8a3b7]",h),type:"button",children:d?(u=c.find(f=>f.value===d))==null?void 0:u.label:w})})})}function ke(){const m=j(re),h=j(ue),[d]=X();return t.jsxs("header",{className:"relative z-50 flex gap-x-1 gap-y-1 items-end",children:[t.jsx("h1",{className:"title",children:"Журнал"}),t.jsx(K,{className:"min-w-10",placeholder:"Класс",options:(m||[]).map(c=>({value:c.id.toString(),label:`${c.level} ${c.group}`})),value:d.get("gradeId")||""}),t.jsx(K,{className:"grow max-w-[320px]",placeholder:"Предмет",options:(h||[]).map(c=>({value:c.id.toString(),label:c.name})),value:d.get("subjectId")||""})]})}const De=o.memo(ke);function Ue(){const m=W(),h=j(le),d=j(fe),c=j(pe),w=j(de);return o.useEffect(()=>{h===Y.Idle&&m(ae()),d===Y.Idle&&m(ne()),c===Y.Idle&&m(oe()),w===Y.Idle&&m(ie())},[m,h,w,d,c]),t.jsxs("main",{className:"flex flex-col gap-y-1 py-2",children:[t.jsx(De,{}),t.jsx($e,{})]})}export{Ue as default};
