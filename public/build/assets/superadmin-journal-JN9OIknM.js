const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lesson-edit-BjQMbsch.js","assets/main-yWuhb5Gt.js","assets/preload-helper-BfFHrpNk.js","assets/main-DNTo822Q.css","assets/icons-CK1IQmfH.js","assets/lessons-journal-edit-form-BCHVkgAw.js","assets/button-BKPH64SX.js","assets/select-field-RirYMWTT.js","assets/cleanable-DQsDMRP2.js","assets/formik.esm-BRAvGE8Y.js","assets/use-dropdown-D2SgKNhE.js","assets/index.browser-OxPLOBIU.js","assets/text-field-DEwqXaiJ.js","assets/lessons-selector-BPWWn4-E.js"])))=>i.map(i=>d[i]);
import{r as c,t as I,j as a,c as E,S as X,a as q,u as R,p as Q,ae as L,af as O,i as B,aj as ee,ak as te,y as D,al as se,am as ae,an as ne,L as re,X as ie,A as oe,n as le,C as ce,v as me,W as ue}from"./main-yWuhb5Gt.js";import{a as de,g as fe}from"./grades-selector-B6pCE8aG.js";import{b as xe,a as ge,g as pe}from"./ratings-selector-B9nmlOOI.js";import{a as he,g as be}from"./subjects-selector-Ct0p-0h9.js";import{a as ye,g as we}from"./users-selector-D5J-7fb-.js";import{b as Z,a as K,c as Se}from"./ratings-CKd6Gnpx.js";import{c as ve,g as je}from"./index-CYT10vT5.js";import{_ as Ne}from"./preload-helper-BfFHrpNk.js";import{u as _e,c as Ce,f as $e}from"./index-bMPnDbnu.js";import{u as Me}from"./use-dropdown-D2SgKNhE.js";const Re=c.lazy(()=>Ne(()=>import("./lesson-edit-BjQMbsch.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])));function ke({data:m,columns:w,setLessons:f,lessonObject:b}){const[d,p]=c.useState(),[h,$]=c.useState({left:["name"],right:[]}),_=_e({data:m,columns:w,getCoreRowModel:Ce(),state:{columnPinning:h},onColumnPinningChange:$}),S=c.useCallback(x=>l=>{const v=l.currentTarget.getBoundingClientRect(),y=v.top+80+4,k=v.left;p({dto:{id:x.id,topic:x.topic,homework:x.homework,type_id:x.typeId},position:{top:y,left:k},title:I(x.date).format("DD MMMM YYYY"),onClose:()=>p(void 0),onSuccess:P=>f((A=[])=>{const j=A.findIndex(N=>N.id===P.id);return j!==-1&&(A[j]=P),[...A]})})},[f]);return a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex flex-col rounded-md shadow border bg-white overflow-scroll max-h-[calc(100vh-52px)] styled-scrollbar text-sm md:text-[16px]",children:[a.jsx("div",{className:"sticky top-0 z-40 shadow min-w-max",children:_.getHeaderGroups().map(x=>a.jsxs("div",{className:"flex",children:[a.jsx("div",{className:"flex items-end leading-none justify-end p-1 min-w-7 max-w-7 font-semibold bg-gray-100 md:p-2 md:min-w-9 md:max-w-9",children:"№"}),x.headers.map(l=>l.id==="name"?a.jsx("div",{className:"flex items-end bg-gray-100 p-1 md:p-2 leading-none font-semibold min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px] min-h-20 max-h-20 sticky left-0 z-10 border-r",children:"Ф.И."},l.id):l.id.length===13?a.jsx("div",{className:"relative flex bg-gray-100 min-w-9 max-w-9 min-h-[80px] max-h-[80px] border-r text-[13px]",children:a.jsx("span",{className:"absolute left-full bottom-0 flex items-center justify-start px-1 origin-bottom-left -rotate-90 h-9 w-[80px] text-blue-600",children:Z[+l.id.split("_")[1]]})},l.id):a.jsx("div",{className:"flex flex-col min-h-[80px] max-h-[80px] min-w-9 max-w-9",children:a.jsxs("button",{className:"relative flex items-center grow justify-center font-normal bg-gray-100 border-r cursor-pointer duration-150 hover:bg-gray-200",onClick:S(b[l.id]),children:[a.jsx("span",{className:"font-semibold mt-auto",children:l.id.split("_")[0].slice(-2)}),a.jsx("span",{className:"absolute left-0 top-[52px] origin-top-left -rotate-90 h-9 flex items-center w-12  text-sm",children:ve(I(l.id.split("_")[0]).format("MMM"))})]})},l.id))]},x.id))}),a.jsx("div",{className:"min-w-max",children:_.getRowModel().rows.map((x,l)=>a.jsxs("div",{className:E("flex",l%2?"bg-gray-50":"bg-white"),children:[a.jsxs("div",{className:E("flex items-center justify-end p-1 min-w-7 max-w-7 min-h-9 max-h-9 md:p-2 md:min-w-9 md:max-w-9",l%2?"bg-gray-50":"bg-white"),children:[l+1,"."]}),x.getVisibleCells().map((v,y)=>{var k;return a.jsx("div",{className:E(y===0&&"sticky left-0 border-r",l%2?"bg-gray-50 border-r":"bg-white border-r",(k=v.column.columnDef.meta)==null?void 0:k.columnClass),children:$e(v.column.columnDef.cell,v.getContext())},JSON.stringify(v))})]},x.original.id))})]}),d&&a.jsx(c.Suspense,{fallback:a.jsx(X,{className:"w-8 h-8"}),children:a.jsx(Re,{...d})})]})}const Ae=c.memo(ke);function Ee(){const m=q(),w=R(xe),f=R(ge),b=R(ye),[d]=Q(),p=d.get("subjectId"),h=d.get("gradeId"),$=je(),_=f==null?void 0:f.find(({years:t})=>t==$),[S,x]=c.useState(),[l,v]=c.useState(),[y,k]=c.useState(),[P,A]=c.useState();c.useEffect(()=>{p&&h&&(m(L({subjectId:+p,gradeId:+h,onSuccess:t=>{x(t),m(O({lessons:t.map(({id:e})=>e),onSuccess:e=>k(e)}))}})),w!==B.Loading&&m(ee({years:$,subjectId:+p,gradeId:+h,onSuccess:t=>v(t)})))},[m,h,w,p,$]);const j=c.useMemo(()=>{const t={};if(l)return l.forEach(e=>{const s=`${e.studentId}_${K[e.rating]}`;t[s]=e}),t},[l]),N=c.useMemo(()=>{const t={};if(y)return y.forEach(e=>{const s=`${e.studentId}_${e.lessonId}`;t[s]=e}),t},[y]),F=c.useMemo(()=>{const t={};if(S)return S.forEach(e=>{const s=`${e.date}_${e.hour}_${e.id}`;t[s]=e}),t},[S]),M=c.useMemo(()=>{if(_&&S){const t=S.map(e=>`${e.date}_${e.hour}_${e.id}`);return Object.entries(K).forEach(([e,s])=>{_[e]&&t.push(`${_[e]}_${s}`)}),t.sort(),t}},[_,S]),n=c.useMemo(()=>{if(M)return M.reduce((e,s)=>{if(s.length===13){const r=Number(s.split("_")[1]);e.data[r]=e.lessonIds,e.lessonIds=[]}else{const r=Number(s.split("_")[2]);e.lessonIds.push(r)}return e},{lessonIds:[],data:{}})},[M]),T=c.useMemo(()=>{if(M&&b&&h&&p&&y)return b.filter(t=>{var e;return((e=t.student)==null?void 0:e.gradeId)===+h}).map(t=>{const e=M.reduce((s,r)=>{if(r.length==13){const o=j==null?void 0:j[`${t.id}_${r.split("_")[1]}`];s[r]=o}else{const o=N==null?void 0:N[`${t.id}_${r.split("_")[2]}`];s[r]=o}return s},{});return{id:t.id,name:`${t.surname} ${t.name}`,...e}})},[h,M,N,y,j,p,b]),z=c.useCallback(t=>async e=>{const s=+e.target.value.trim();if(s&&s>=1&&s<=10&&s!==+e.target.defaultValue)e.target.classList.add("opacity-50"),t.score=s,await m(te({dto:t,onSuccess:r=>v((o=[])=>[...o,r]),onValidationError:r=>D.error(r.message),onFail:r=>D.success(r)})),e.target.classList.remove("opacity-50");else{e.target.value=e.target.defaultValue;return}},[m]),J=c.useCallback(t=>async e=>{const s=+e.target.value.trim();if(s&&s>=1&&s<=10&&t.score!==s)e.target.classList.add("opacity-50"),t.score=s,await m(se({dto:t,onSuccess:r=>v((o=[])=>{const i=o.findIndex(u=>u.id===r.id);return i!==-1&&(o[i]=r),[...o]}),onValidationError:r=>D.error(r.message),onFail:r=>D.error(r)})),e.target.classList.remove("opacity-50");else{e.target.value=e.target.defaultValue;return}},[m]),U=c.useCallback(t=>async e=>{const s=e.target.value.toLowerCase().trim();if(s==="н")t.attendance="A";else{const[r,o]=s.split(/ (.+)/),[i,u]=r.split("/");if(!(+i>=1&&+i<=10)){e.target.value="";return}if(u&&!(+u>=1&&+u<=10)){e.target.value="";return}t.score_1=+i,t.score_2=+u||void 0,t.comment=o==null?void 0:o.trim(),t.attendance="P"}e.target.classList.add("opacity-50"),await m(ae({dto:t,onSuccess:r=>k((o=[])=>[...o,r]),onFail:r=>D.success(r)})),e.target.classList.remove("opacity-50")},[m]),G=c.useCallback(t=>async e=>{const s=e.target.value.toLowerCase().trim(),r=JSON.parse(JSON.stringify(t));if(s==="н")t.attendance="A";else{const[o,i]=s.split(/ (.+)/),[u,g]=o.split("/");if(!(+u>=1&&+u<=10)){e.target.value="",A(void 0);return}if(g&&!(+g>=1&&+g<=10)){e.target.value="",A(void 0);return}t.score_1=+u,t.score_2=+g||void 0,i&&(t.comment=i.trim()),t.attendance="P"}e.target.classList.add("opacity-50"),JSON.stringify(r)!==JSON.stringify(t)&&await m(ne({dto:t,onSuccess:o=>k((i=[])=>{const u=i.findIndex(g=>g.id===o.id);return u!==-1&&(i[u]=o),[...i]}),onFail:o=>D.success(o)})),e.target.classList.remove("opacity-50"),A(void 0)},[m]),H=c.useMemo(()=>{if(M&&h&&p&&N)return[{id:"name",accessorKey:"name",header:"Ф.И.",size:180,cell:({row:t})=>a.jsx(re,{className:"flex items-center px-1 w-max h-max leading-none",to:ie(oe.Users.Show,{id:t.original.id}),children:t.original.name}),meta:{columnClass:"flex items-center min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px]"}},...M.reduce((t,e)=>{if(e.length===13){const[,s]=e.split("_");t.push({id:e,accessorKey:e,header:Z[+s],cell:({row:r})=>{const o=j==null?void 0:j[`${r.original.id}_${s}`];if(!o){let i=0,u=0,g=[];s==="93"?g=[...(n==null?void 0:n.data[91])||[],...(n==null?void 0:n.data[92])||[],...(n==null?void 0:n.data[93])||[]]:s==="96"?g=[...(n==null?void 0:n.data[94])||[],...(n==null?void 0:n.data[95])||[],...(n==null?void 0:n.data[96])||[]]:s==="97"?g=[...(n==null?void 0:n.data[91])||[],...(n==null?void 0:n.data[92])||[],...(n==null?void 0:n.data[93])||[],...(n==null?void 0:n.data[94])||[],...(n==null?void 0:n.data[95])||[],...(n==null?void 0:n.data[96])||[]]:g=(n==null?void 0:n.data[+s])||[],y==null||y.map(C=>{g!=null&&g.includes(C.lessonId)&&C.studentId===r.original.id&&(C.score1&&(i=i+C.score1,u=u+1),C.score2&&(i=i+C.score2,u=u+1))});const V=i/u||0,Y=!["98","99"].includes(s)&&V.toFixed(2)||"";return a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 cursor-pointer hover:bg-blue-50 bg-transparent focus:outline-0 text-blue-500 placeholder:text-blue-300",type:"number",onBlur:z({rating:Se[+s],years:$,student_id:r.original.id,grade_id:+h,subject_id:+p}),placeholder:Y})}return a.jsx("input",{className:"flex justify-center items-center text-center font-semibold text-blue-500 min-w-9 min-h-9 cursor-pointer hover:bg-blue-50 bg-transparent focus:outline-0",type:"number",onBlur:J({id:o.id,score:o.score}),defaultValue:o.score})},meta:{columnClass:"flex items-center justify-end min-w-9 max-w-9 min-h-9 max-h-9"}})}else{const[s,,r]=e.split("_");t.push({id:e,accessorKey:e,header:s,size:40,cell:({row:o})=>{var g,V;const i=N==null?void 0:N[`${o.original.id}_${r}`];if(!i)return I(s)>I()?void 0:a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5 bg-transparent focus:outline-0",onBlur:U({attendance:"",lesson_id:+r,student_id:o.original.id})});let u="";if(i.score1||i.score2){const Y=((g=i.score1)==null?void 0:g.toString())??"",C=((V=i.score2)==null?void 0:V.toString())??"";u=Y&&C?`${Y}/${C}`:Y||C}else i.attendance==="A"&&(u="н");return a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 cursor-pointer hover:bg-gray-600/5 bg-transparent focus:outline-0",onBlur:G({id:i.id,score_1:i.score1,score_2:i.score2,attendance:i.attendance,comment:i.comment}),onFocus:()=>A(i.comment),defaultValue:u})},enableSorting:!1,meta:{columnClass:E("flex items-center justify-center min-w-9 max-w-9 min-h-9 max-h-9 border-r",I(s).format("YYYY-MM-DD")===I().format("YYYY-MM-DD")&&"!bg-green-50")}})}return t},[])]},[h,M,N,y,U,G,z,J,n==null?void 0:n.data,j,p,$]);if(!(!h||!p))return!T||!H?a.jsx(X,{className:"w-8 h-8"}):a.jsxs(a.Fragment,{children:[F&&a.jsx(Ae,{data:T,columns:H,setLessons:x,lessonObject:F}),P&&a.jsx("div",{className:"fixed right-1 bottom-1 m-0 bg-white py-1 px-2 border",children:P})]})}const De=c.memo(Ee);function W({className:m,inputClass:w,value:f,onChange:b,options:d,placeholder:p}){var x;const{ref:h,menuRef:$,isOpen:_,setIsOpen:S}=Me();return a.jsxs("div",{ref:h,className:E(m,"relative flex flex-col"),children:[a.jsx("div",{className:"relative flex",children:a.jsx("button",{className:E("flex items-center min-h-8 max-h-8 grow bg-gray-50 min-w-0 border border-gray-200 rounded px-2 leading-none text-sm focus:outline-none hover:bg-gray-100 focus:border-primary focus:bg-gray-100 md:text-[16px]",!f&&"text-[#a8a3b7]",w),type:"button",onClick:l=>!l.target.classList.contains("remove-selection")&&S(!_),children:f?(x=d.find(l=>l.value===f))==null?void 0:x.label:p})}),a.jsx("div",{ref:$,className:E("absolute top-[calc(100%+4px)] right-0 z-10 border rounded-md pb-1 bg-white shadow-sm text-sm min-w-max w-full text-gray-500",_?"visible opacity-100":"invisible opacity-0"),children:a.jsx("ul",{className:"max-h-56 overflow-y-auto scrollbar-y",children:d.map(l=>a.jsx("li",{children:a.jsx("button",{className:"flex w-full items-center h-8 transition-all duration-150 hover:bg-green-50 px-3",type:"button",onClick:()=>{b(l.value),S(!1)},children:l.label})},l.value))})})]})}function Ie(){const m=R(de),w=R(he),[f,b]=Q();return a.jsxs("header",{className:"relative z-50 flex gap-x-1 gap-y-1 items-end",children:[a.jsx("h1",{className:"title",children:"Журнал"}),a.jsx(W,{className:"min-w-10",placeholder:"Класс",options:(m||[]).map(d=>({value:d.id.toString(),label:`${d.level} ${d.group}`})),value:f.get("gradeId")||"",onChange:d=>b({subjectId:f.get("subjectId")||"",gradeId:d})}),a.jsx(W,{className:"grow max-w-[320px]",placeholder:"Предмет",options:(w||[]).map(d=>({value:d.id.toString(),label:d.name})),value:f.get("subjectId")||"",onChange:d=>b({gradeId:f.get("gradeId")||"",subjectId:d})})]})}const Pe=c.memo(Ie);function Ke(){const m=q(),w=R(fe),f=R(be),b=R(we),d=R(pe);return c.useEffect(()=>{w===B.Idle&&m(le()),f===B.Idle&&m(ce()),b===B.Idle&&m(me()),d===B.Idle&&m(ue())},[m,w,d,f,b]),a.jsxs("main",{className:"flex flex-col gap-y-1 py-2",children:[a.jsx(Pe,{}),a.jsx(De,{})]})}export{Ke as default};
