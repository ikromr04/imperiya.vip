const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lesson-edit-DRL1yEwn.js","assets/main-DzOvJ3Bl.js","assets/preload-helper-BfFHrpNk.js","assets/main-CSYpzwAj.css","assets/icons-B5TgyNC1.js","assets/lessons-journal-edit-form-Chh17a4S.js","assets/button-BK2ewXLd.js","assets/select-field-Dot3bTik.js","assets/cleanable-37L1pogH.js","assets/formik.esm-Cpulkf5n.js","assets/use-dropdown-D7UlQ3WZ.js","assets/index.browser-OxPLOBIU.js","assets/text-field-yJsTwbK9.js","assets/lessons-selector-53yG18IO.js"])))=>i.map(i=>d[i]);
import{r as c,t as Y,j as a,c as P,S as X,a as q,u as A,p as Q,ae as O,af as ee,i as B,aj as te,ak as se,y as I,al as ae,am as ne,an as re,L as ie,X as oe,A as le,n as ce,C as ue,v as me,W as de}from"./main-DzOvJ3Bl.js";import{a as fe,g as xe}from"./grades-selector-XXuKk_5g.js";import{b as ge,a as pe,g as he}from"./ratings-selector-CZBQg-ih.js";import{a as ye,g as be}from"./subjects-selector-CkFIZtiD.js";import{a as we,g as Se}from"./users-selector-BLV6X7VS.js";import{b as Z,a as K,c as _e}from"./ratings-CKd6Gnpx.js";import{c as je,g as Ne}from"./index-DnzxYe6g.js";import{_ as ve}from"./preload-helper-BfFHrpNk.js";import{u as Ce,c as $e,f as Me}from"./index-D18-tjuz.js";import{u as Re}from"./use-dropdown-D7UlQ3WZ.js";const ke=c.lazy(()=>ve(()=>import("./lesson-edit-DRL1yEwn.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])));function Ae({data:u,columns:S,setLessons:f,lessonObject:y}){const[m,g]=c.useState(),[p,$]=c.useState({left:["name"],right:[]}),C=Ce({data:u,columns:S,getCoreRowModel:$e(),state:{columnPinning:p},onColumnPinningChange:$}),_=c.useCallback(x=>o=>{const j=o.currentTarget.getBoundingClientRect(),b=j.top+80+4,D=j.left;g({dto:{id:x.id,topic:x.topic,homework:x.homework,type_id:x.typeId},position:{top:b,left:D},title:Y(x.date).format("DD MMMM YYYY"),onClose:()=>g(void 0),onSuccess:V=>f((E=[])=>{const N=E.findIndex(v=>v.id===V.id);return N!==-1&&(E[N]=V),[...E]})})},[f]);return a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex flex-col rounded-md shadow border bg-white overflow-scroll max-h-[calc(100vh-52px)] styled-scrollbar text-sm md:text-[16px]",children:[a.jsx("div",{className:"sticky top-0 z-40 shadow min-w-max",children:C.getHeaderGroups().map(x=>a.jsxs("div",{className:"flex",children:[a.jsx("div",{className:"flex items-end leading-none justify-end p-1 min-w-7 max-w-7 font-semibold bg-gray-100 md:p-2 md:min-w-9 md:max-w-9",children:"№"}),x.headers.map(o=>o.id==="name"?a.jsx("div",{className:"flex items-end bg-gray-100 p-1 md:p-2 leading-none font-semibold min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px] min-h-20 max-h-20 sticky left-0 z-10 border-r",children:"Ф.И."},o.id):o.id.length===13?a.jsx("div",{className:"relative flex bg-gray-100 min-w-9 max-w-9 min-h-[80px] max-h-[80px] border-r text-[13px]",children:a.jsx("span",{className:"absolute left-full bottom-0 flex items-center justify-start px-1 origin-bottom-left -rotate-90 h-9 w-[80px] text-blue-600",children:Z[+o.id.split("_")[1]]})},o.id):a.jsx("div",{className:"flex flex-col min-h-[80px] max-h-[80px] min-w-9 max-w-9",children:a.jsxs("button",{className:"relative flex items-center grow justify-center font-normal bg-gray-100 border-r cursor-pointer duration-150 hover:bg-gray-200",onClick:_(y[o.id]),children:[a.jsx("span",{className:"font-semibold mt-auto",children:o.id.split("_")[0].slice(-2)}),a.jsx("span",{className:"absolute left-0 top-[52px] origin-top-left -rotate-90 h-9 flex items-center w-12  text-sm",children:je(Y(o.id.split("_")[0]).format("MMM"))})]})},o.id))]},x.id))}),a.jsx("div",{className:"min-w-max",children:C.getRowModel().rows.map((x,o)=>a.jsxs("div",{className:P("flex",o%2?"bg-gray-50":"bg-white"),children:[a.jsxs("div",{className:P("flex items-center justify-end p-1 min-w-7 max-w-7 min-h-9 max-h-9 md:p-2 md:min-w-9 md:max-w-9",o%2?"bg-gray-50":"bg-white"),children:[o+1,"."]}),x.getVisibleCells().map((j,b)=>{var D;return a.jsx("div",{className:P(b===0&&"sticky left-0 border-r",o%2?"bg-gray-50 border-r":"bg-white border-r",(D=j.column.columnDef.meta)==null?void 0:D.columnClass),children:Me(j.column.columnDef.cell,j.getContext())},JSON.stringify(j))})]},x.original.id))})]}),m&&a.jsx(c.Suspense,{fallback:a.jsx(X,{className:"w-8 h-8"}),children:a.jsx(ke,{...m})})]})}const De=c.memo(Ae);function Ee(){const u=q(),S=A(ge),f=A(pe),y=A(we),[m]=Q(),g=m.get("subjectId"),p=m.get("gradeId"),$=Ne(),C=f==null?void 0:f.find(({years:t})=>t==$),[_,x]=c.useState(),[o,j]=c.useState(),[b,D]=c.useState(),[V,E]=c.useState();c.useEffect(()=>{g&&p&&(u(O({subjectId:+g,gradeId:+p,onSuccess:t=>{x(t),u(ee({lessons:t.map(({id:e})=>e),onSuccess:e=>D(e)}))}})),S!==B.Loading&&u(te({years:$,subjectId:+g,gradeId:+p,onSuccess:t=>j(t)})))},[u,p,S,g,$]);const N=c.useMemo(()=>{const t={};if(o)return o.forEach(e=>{const s=`${e.studentId}_${K[e.rating]}`;t[s]=e}),t},[o]),v=c.useMemo(()=>{const t={};if(b)return b.forEach(e=>{const s=`${e.studentId}_${e.lessonId}`;t[s]=e}),t},[b]),F=c.useMemo(()=>{const t={};if(_)return _.forEach(e=>{const s=`${e.date}_${e.hour}_${e.id}`;t[s]=e}),t},[_]),M=c.useMemo(()=>{if(C&&_){const t=_.map(e=>`${e.date}_${e.hour}_${e.id}`);return Object.entries(K).forEach(([e,s])=>{C[e]&&t.push(`${C[e]}_${s}`)}),t.sort(),t}},[C,_]),n=c.useMemo(()=>{if(M)return M.reduce((e,s)=>{if(s.length===13){const r=Number(s.split("_")[1]);e.data[r]=e.lessonIds,e.lessonIds=[]}else{const r=Number(s.split("_")[2]);e.lessonIds.push(r)}return e},{lessonIds:[],data:{}})},[M]),T=c.useMemo(()=>{if(M&&y&&p&&g&&b)return y.filter(t=>{var e;return((e=t.student)==null?void 0:e.gradeId)===+p}).map(t=>{const e=M.reduce((s,r)=>{if(r.length==13){const l=N==null?void 0:N[`${t.id}_${r.split("_")[1]}`];s[r]=l}else{const l=v==null?void 0:v[`${t.id}_${r.split("_")[2]}`];s[r]=l}return s},{});return{id:t.id,name:`${t.surname} ${t.name}`,...e}})},[p,M,v,b,N,g,y]),z=c.useCallback(t=>async e=>{const s=+e.target.value.trim();if(s&&s>=1&&s<=10&&s!==+e.target.defaultValue)e.target.classList.add("opacity-50"),t.score=s,await u(se({dto:t,onSuccess:r=>j((l=[])=>[...l,r]),onValidationError:r=>I.error(r.message),onFail:r=>I.success(r)})),e.target.classList.remove("opacity-50");else{e.target.value=e.target.defaultValue;return}},[u]),J=c.useCallback(t=>async e=>{const s=+e.target.value.trim();if(s&&s>=1&&s<=10&&t.score!==s)e.target.classList.add("opacity-50"),t.score=s,await u(ae({dto:t,onSuccess:r=>j((l=[])=>{const i=l.findIndex(d=>d.id===r.id);return i!==-1&&(l[i]=r),[...l]}),onValidationError:r=>I.error(r.message),onFail:r=>I.error(r)})),e.target.classList.remove("opacity-50");else{e.target.value=e.target.defaultValue;return}},[u]),U=c.useCallback(t=>async e=>{const s=e.target.value.toLowerCase().trim();if(s==="н")t.attendance="A";else if(s==="п")t.attendance="P";else{const[r,l]=s.split(/ (.+)/),[i,d]=r.split("/");if(!(+i>=1&&+i<=10)){e.target.value="";return}if(d&&!(+d>=1&&+d<=10)){e.target.value="";return}t.score_1=+i,t.score_2=+d||void 0,t.comment=l==null?void 0:l.trim(),t.attendance="P"}e.target.classList.add("opacity-50"),await u(ne({dto:t,onSuccess:r=>D((l=[])=>[...l,r]),onFail:r=>I.success(r)})),e.target.classList.remove("opacity-50")},[u]),G=c.useCallback(t=>async e=>{const s=e.target.value.toLowerCase().trim(),r=JSON.parse(JSON.stringify(t)),[l,i]=s.split(/ (.+)/),[d,h]=l.split("/");if(s==="н")t.attendance="A",t.score_1=null,t.score_2=null,t.comment=null;else if(s==="п")t.attendance="P",t.score_1=null,t.score_2=null,t.comment=i?i.trim():null;else{if(!(+d>=1&&+d<=10)){e.target.value=e.target.defaultValue,E(void 0);return}if(h&&!(+h>=1&&+h<=10)){e.target.value=e.target.defaultValue,E(void 0);return}t.score_1=+d,t.score_2=+h||null,i&&(t.comment=i.trim()),t.attendance="P"}e.target.classList.add("opacity-50"),JSON.stringify(r)!==JSON.stringify(t)&&await u(re({dto:t,onSuccess:R=>D((k=[])=>{const w=k.findIndex(L=>L.id===R.id);return w!==-1&&(k[w]=R),[...k]}),onFail:R=>I.success(R)})),e.target.classList.remove("opacity-50"),E(void 0)},[u]),H=c.useMemo(()=>{if(M&&p&&g&&v)return[{id:"name",accessorKey:"name",header:"Ф.И.",size:180,cell:({row:t})=>a.jsx(ie,{className:"flex items-center px-1 w-max h-max leading-none",to:oe(le.Users.Show,{id:t.original.id}),children:t.original.name}),meta:{columnClass:"flex items-center min-w-[180px] max-w-[180px)] md:min-w-[220px] md:max-w-[220px]"}},...M.reduce((t,e)=>{if(e.length===13){const[,s]=e.split("_");t.push({id:e,accessorKey:e,header:Z[+s],cell:({row:r})=>{const l=N==null?void 0:N[`${r.original.id}_${s}`];if(!l){let i=0,d=0,h=[];s==="93"?h=[...(n==null?void 0:n.data[91])||[],...(n==null?void 0:n.data[92])||[],...(n==null?void 0:n.data[93])||[]]:s==="96"?h=[...(n==null?void 0:n.data[94])||[],...(n==null?void 0:n.data[95])||[],...(n==null?void 0:n.data[96])||[]]:s==="97"?h=[...(n==null?void 0:n.data[91])||[],...(n==null?void 0:n.data[92])||[],...(n==null?void 0:n.data[93])||[],...(n==null?void 0:n.data[94])||[],...(n==null?void 0:n.data[95])||[],...(n==null?void 0:n.data[96])||[]]:h=(n==null?void 0:n.data[+s])||[],b==null||b.map(w=>{h!=null&&h.includes(w.lessonId)&&w.studentId===r.original.id&&(w.score1&&(i=i+w.score1,d=d+1),w.score2&&(i=i+w.score2,d=d+1))});const R=i/d||0,k=!["98","99"].includes(s)&&R.toFixed(2)||"";return a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 bg-transparent focus:outline-0 text-blue-500 placeholder:text-blue-300",type:"number",readOnly:!0,onBlur:z({rating:_e[+s],years:$,student_id:r.original.id,grade_id:+p,subject_id:+g}),placeholder:k})}return a.jsx("input",{className:"flex justify-center items-center text-center font-semibold text-blue-500 min-w-9 min-h-9 bg-transparent focus:outline-0",type:"number",readOnly:!0,onBlur:J({id:l.id,score:l.score}),defaultValue:l.score})},meta:{columnClass:"flex items-center justify-end min-w-9 max-w-9 min-h-9 max-h-9"}})}else{const[s,,r]=e.split("_");t.push({id:e,accessorKey:e,header:s,size:40,cell:({row:l})=>{var h,R;const i=v==null?void 0:v[`${l.original.id}_${r}`];if(!i)return Y(s)>Y()?void 0:a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 bg-transparent focus:outline-0",readOnly:!0,onBlur:U({attendance:"",lesson_id:+r,student_id:l.original.id})});let d="";if(i.score1||i.score2){const k=((h=i.score1)==null?void 0:h.toString())??"",w=((R=i.score2)==null?void 0:R.toString())??"";d=k&&w?`${k}/${w}`:k||w}else i.attendance==="A"?d="н":i.attendance==="P"&&(d="п");return a.jsx("input",{className:"flex justify-center items-center text-center min-w-9 min-h-9 bg-transparent focus:outline-0",readOnly:!0,onBlur:G({id:i.id,score_1:i.score1||null,score_2:i.score2||null,attendance:i.attendance,comment:i.comment||null}),onFocus:()=>E(i.comment),defaultValue:d})},enableSorting:!1,meta:{columnClass:P("flex items-center justify-center min-w-9 max-w-9 min-h-9 max-h-9 border-r",Y(s).format("YYYY-MM-DD")===Y().format("YYYY-MM-DD")&&"!bg-green-50")}})}return t},[])]},[p,M,v,b,U,G,z,J,n==null?void 0:n.data,N,g,$]);if(!(!p||!g))return!T||!H?a.jsx(X,{className:"w-8 h-8"}):a.jsxs(a.Fragment,{children:[F&&a.jsx(De,{data:T,columns:H,setLessons:x,lessonObject:F}),V&&a.jsx("div",{className:"fixed right-1 bottom-1 m-0 bg-white py-1 px-2 border",children:V})]})}const Pe=c.memo(Ee);function W({className:u,inputClass:S,value:f,onChange:y,options:m,placeholder:g}){var x;const{ref:p,menuRef:$,isOpen:C,setIsOpen:_}=Re();return a.jsxs("div",{ref:p,className:P(u,"relative flex flex-col"),children:[a.jsx("div",{className:"relative flex",children:a.jsx("button",{className:P("flex items-center min-h-8 max-h-8 grow bg-gray-50 min-w-0 border border-gray-200 rounded px-2 leading-none text-sm focus:outline-none hover:bg-gray-100 focus:border-primary focus:bg-gray-100 md:text-[16px]",!f&&"text-[#a8a3b7]",S),type:"button",onClick:o=>!o.target.classList.contains("remove-selection")&&_(!C),children:f?(x=m.find(o=>o.value===f))==null?void 0:x.label:g})}),a.jsx("div",{ref:$,className:P("absolute top-[calc(100%+4px)] right-0 z-10 border rounded-md pb-1 bg-white shadow-sm text-sm min-w-max w-full text-gray-500",C?"visible opacity-100":"invisible opacity-0"),children:a.jsx("ul",{className:"max-h-56 overflow-y-auto scrollbar-y",children:m.map(o=>a.jsx("li",{children:a.jsx("button",{className:"flex w-full items-center h-8 transition-all duration-150 hover:bg-green-50 px-3",type:"button",onClick:()=>{y(o.value),_(!1)},children:o.label})},o.value))})})]})}function Ie(){const u=A(fe),S=A(ye),[f,y]=Q();return a.jsxs("header",{className:"relative z-50 flex gap-x-1 gap-y-1 items-end",children:[a.jsx("h1",{className:"title",children:"Журнал"}),a.jsx(W,{className:"min-w-10",placeholder:"Класс",options:(u||[]).map(m=>({value:m.id.toString(),label:`${m.level} ${m.group}`})),value:f.get("gradeId")||"",onChange:m=>y({subjectId:f.get("subjectId")||"",gradeId:m})}),a.jsx(W,{className:"grow max-w-[320px]",placeholder:"Предмет",options:(S||[]).map(m=>({value:m.id.toString(),label:m.name})),value:f.get("subjectId")||"",onChange:m=>y({gradeId:f.get("gradeId")||"",subjectId:m})})]})}const Ye=c.memo(Ie);function We(){const u=q(),S=A(xe),f=A(be),y=A(Se),m=A(he);return c.useEffect(()=>{S===B.Idle&&u(ce()),f===B.Idle&&u(ue()),y===B.Idle&&u(me()),m===B.Idle&&u(de())},[u,S,m,f,y]),a.jsxs("main",{className:"flex flex-col gap-y-1 py-2",children:[a.jsx(Ye,{}),a.jsx(Pe,{})]})}export{We as default};
